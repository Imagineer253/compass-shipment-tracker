{% extends "base.html" %}

{% block title %}Import Shipment Details{% endblock %}

{% block content %}
<style>
    /* Base styles */
    .form-section {
        transition: all 0.3s ease;
    }

    .input-field {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--arctic-blue);
        background-color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
    }

    .input-field:focus {
        outline: none;
        border: 2px solid var(--deep-arctic);
        box-shadow: 0 0 0 2px rgba(30, 63, 102, 0.1);
    }

    .input-field:invalid:not(:placeholder-shown) {
        border-color: #EF4444;
        background-color: #FEF2F2;
    }

    .input-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.25rem;
    }

    .invoice-preview {
        background: linear-gradient(145deg, #E3F2FD, #F0F8FF);
        border-radius: 0.75rem;
        padding: 1.5rem;
        border: 2px solid var(--arctic-blue);
        position: sticky;
        top: 1rem;
    }

    .radio-card {
        transition: all 0.3s ease;
    }

    .radio-card:hover {
        background-color: rgba(176, 226, 255, 0.2);
        transform: translateY(-2px);
    }

    input:checked + .radio-card {
        background: linear-gradient(145deg, #E3F2FD, #BBDEFB);
        border: 2px solid var(--deep-arctic);
        transform: translateY(-4px);
    }

    .readonly-field {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 1rem;
        border-radius: 0.5rem;
        color: #475569;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .section-title {
        color: var(--deep-arctic);
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(30, 63, 102, 0.1);
    }

    /* Package section styles */
    .arctic-card {
        transition: all 0.3s ease;
    }

    .arctic-card:hover {
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }

    /* Animation for new items */
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .items-container > div {
        animation: fadeInScale 0.3s ease-out;
    }

    /* Responsive improvements */
    @media (max-width: 640px) {
        .input-label {
            font-size: 0.875rem;
        }
        
        .arctic-card {
            padding: 1rem;
        }
        
        .grid-cols-3 {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="min-h-[80vh] flex items-start justify-center pt-10">
    <div class="w-full max-w-4xl">
        <!-- Progress Indicator -->
        <div class="arctic-card p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="text-xl mr-2">üì•</span>
                    <h2 class="text-lg font-semibold text-deep-arctic">Import Shipment</h2>
                </div>
                <div class="text-sm text-gray-600">
                    Step 1 of 4
                </div>
            </div>
            <div class="mt-3 h-2 bg-gray-200 rounded-full">
                <div class="h-full w-1/4 bg-deep-arctic rounded-full"></div>
            </div>
        </div>

        <!-- Invoice Number Preview -->
        <div class="arctic-card p-4 mb-6 invoice-preview">
            <h3 class="text-lg font-semibold text-deep-arctic mb-2">Generated Import Reference Number</h3>
            <div class="text-xl font-mono tracking-wide" id="invoiceNumberPreview">
                NCPOR/IMP/YYYY/TYPE/BATCH/FIRSTNAME
            </div>
            <p class="text-sm text-gray-600 mt-2">This number will be used in your import documentation</p>
        </div>

        <!-- Main Form -->
        <div class="arctic-card p-8">
            <h1 class="text-2xl font-bold text-deep-arctic mb-6">Import Shipment Details</h1>
            
            <form method="POST" action="{{ url_for('main.submit_shipment') }}" class="space-y-8">
                <input type="hidden" name="shipment_type" value="{% if is_reimport %}reimport{% else %}import{% endif %}">
                <input type="hidden" name="invoice_date" id="invoiceDateHidden">

                <!-- Personal Details -->
                <div class="space-y-4">
                    <h3 class="section-title">Personal Details</h3>
                    <div>
                        <label class="input-label">Full Name with Title</label>
                        <input type="text" 
                               name="requester_name" 
                               id="requesterName"
                               class="input-field"
                               placeholder="e.g., Dr. John Smith"
                               required>
                        <p class="text-sm text-gray-500 mt-1">Please include appropriate title (Dr./Mr./Ms./etc.)</p>
                    </div>
                </div>

                <!-- Shipment Characteristics -->
                <div class="space-y-4">
                    <h3 class="section-title">Shipment Characteristics</h3>
                    
                    <!-- Purpose Selection -->
                    <div>
                        <label class="input-label">Purpose of Import</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="cursor-pointer">
                                <input type="radio" 
                                       name="import_purpose" 
                                       value="RESEARCH" 
                                       class="sr-only" 
                                       checked
                                       required>
                                <div class="radio-card arctic-card p-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-6 h-6 border-2 border-deep-arctic rounded-full flex items-center justify-center">
                                            <div class="w-3 h-3 bg-deep-arctic rounded-full hidden peer-checked:block"></div>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-deep-arctic">Research</p>
                                            <p class="text-sm text-gray-600">For scientific/research purposes</p>
                                        </div>
                                    </div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" 
                                       name="import_purpose" 
                                       value="EQUIPMENT" 
                                       class="sr-only" 
                                       required>
                                <div class="radio-card arctic-card p-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-6 h-6 border-2 border-deep-arctic rounded-full flex items-center justify-center">
                                            <div class="w-3 h-3 bg-deep-arctic rounded-full hidden peer-checked:block"></div>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-deep-arctic">Equipment</p>
                                            <p class="text-sm text-gray-600">For operational equipment</p>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Expedition Details -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="input-label">Year of Expedition</label>
                            <input type="number" 
                                   name="expedition_year" 
                                   id="expeditionYear"
                                   class="input-field"
                                   min="2000"
                                   max="2100"
                                   placeholder="YYYY"
                                   required>
                        </div>
                        <div>
                            <label class="input-label">Batch Number</label>
                            <input type="text" 
                                   name="batch_number" 
                                   id="batchNumber"
                                   class="input-field"
                                   placeholder="e.g., BATCH5"
                                   required>
                        </div>
                    </div>

                    <!-- Expected Arrival Date -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="input-label">Expected Arrival Date</label>
                            <input type="date" 
                                   name="expected_arrival" 
                                   class="input-field"
                                   required>
                        </div>
                        <div>
                            <label class="input-label">Import Mode</label>
                            <select name="import_mode" class="input-field" required>
                                <option value="">Select Mode of Import</option>
                                <option value="air">Air Freight</option>
                                <option value="sea">Sea Freight</option>
                                <option value="road">Road Transport</option>
                                <option value="personal">Personal Carriage</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Consigner Details Section -->
                <div class="space-y-4">
                    <h3 class="section-title">Consigner Details (From)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Himadri Option -->
                        <label class="cursor-pointer">
                            <input type="radio" 
                                   name="consigner" 
                                   value="himadri" 
                                   class="sr-only" 
                                   id="consignerHimadriRadio"
                                   checked
                                   required>
                            <div class="radio-card arctic-card p-4 h-full">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 border-2 border-deep-arctic rounded-full flex items-center justify-center">
                                        <div class="w-3 h-3 bg-deep-arctic rounded-full hidden peer-checked:block"></div>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-deep-arctic">Himadri</p>
                                        <p class="text-sm text-gray-600">Indian Arctic Research Station</p>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <!-- Others Option -->
                        <label class="cursor-pointer">
                            <input type="radio" 
                                   name="consigner" 
                                   value="other" 
                                   class="sr-only" 
                                   id="consignerOtherRadio">
                            <div class="radio-card arctic-card p-4 h-full">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 border-2 border-deep-arctic rounded-full flex items-center justify-center">
                                        <div class="w-3 h-3 bg-deep-arctic rounded-full hidden peer-checked:block"></div>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-deep-arctic">Other Organization</p>
                                        <p class="text-sm text-gray-600">Different consigner details</p>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Dynamic Consigner Details -->
                    <div id="consignerDetailsSection" class="mt-4">
                        <!-- Himadri Details (Read-only) -->
                        <div id="himadriConsignerDetails">
                    <div class="readonly-field">
                                <strong>Himadri - Indian Arctic Research Station C/O Kingsbay AS</strong><br>
                                N-9173 Ny-Alesund, Norway<br>
                                Point of Contact: Kingsbay AS, Longyearbyen<br>
                                Phone: +47 79 027200
                    </div>
                </div>

                        <!-- Other Consigner Details -->
                        <div id="otherConsignerDetails" class="hidden space-y-4">
                            <div>
                                <label class="input-label">Organization Name</label>
                                <input type="text" 
                                       name="other_consigner_org" 
                                       class="input-field"
                                       placeholder="Enter organization name">
                            </div>
                            <div>
                                <label class="input-label">Complete Address</label>
                                <textarea name="other_consigner_address" 
                                         class="input-field"
                                         rows="4"
                                         placeholder="Enter complete address"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="input-label">Contact Person</label>
                                    <input type="text" 
                                           name="other_consigner_contact" 
                                           class="input-field"
                                           placeholder="Enter contact person name">
                                </div>
                                <div>
                                    <label class="input-label">Designation</label>
                                    <input type="text" 
                                           name="other_consigner_designation" 
                                           class="input-field"
                                           placeholder="Enter designation">
                                </div>
                                <div>
                                    <label class="input-label">Phone Number</label>
                                    <input type="tel" 
                                           name="other_consigner_phone" 
                                           class="input-field"
                                           placeholder="Enter phone number">
                                </div>
                                <div>
                                    <label class="input-label">Email</label>
                                    <input type="email" 
                                           name="other_consigner_email" 
                                           class="input-field"
                                           placeholder="Enter email address">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NCPOR Details (Read-only) -->
                <div id="ncporConsigneeDetails">
                    <div class="readonly-field">
                        National Center for Polar and Ocean Research (NCPOR) [erstwhite NCAOR]<br>
                        Ministry of Earth Sciences (Govt. of India)<br>
                        Headland Sada, Vasco da Gama, Goa - 403804<br>
                        India<br>
                        Phone: +91 832 2525501<br>
                        GST: 30AAAAN4327G1ZJ<br>
                        IEC No.: 1196000125
                    </div>
                </div>

                <!-- Cargo Details Section -->
                <div class="space-y-4 mt-8">
                    <h3 class="section-title">Cargo Details</h3>
                    
                    <!-- Package Details -->
                    <div>
                        <label class="input-label">Number of Packages</label>
                        <input type="number" 
                               name="total_packages" 
                               id="totalPackagesInput"
                               class="input-field"
                               min="1"
                               placeholder="Enter number of packages"
                               required>
                    </div>

                    <!-- Package Details Container -->
                    <div id="packageDetailsContainer" class="hidden space-y-6 mt-6">
                        <!-- Package details will be dynamically added here -->
                    </div>

                    <!-- Package Summary -->
                    <div id="packageSummary" class="arctic-card p-6 mt-8 hidden">
                        <h4 class="text-xl font-semibold text-deep-arctic mb-4">Shipment Summary</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <p class="text-sm text-gray-600">Total Packages</p>
                                <p class="text-lg font-medium" id="summaryTotalPackages">0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Total Items</p>
                                <p class="text-lg font-medium" id="summaryTotalItems">0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Gross Weight</p>
                                <p class="text-lg font-medium" id="summaryGrossWeight">0 kg</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Total Value</p>
                                <p class="text-lg font-medium" id="summaryTotalValue">0 USD</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customs & Clearance Details -->
                <div class="space-y-4">
                    <h3 class="section-title">Customs & Clearance Details</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="input-label">Customs Duty Exemption</label>
                            <select name="duty_exemption" class="input-field" required>
                                <option value="">Select Option</option>
                                <option value="yes">Yes, Exempt</option>
                                <option value="no">No, Regular Duty Applies</option>
                            </select>
                        </div>
                        <div>
                            <label class="input-label">Exemption Certificate Number (if applicable)</label>
                            <input type="text" 
                                   name="exemption_number" 
                                   class="input-field"
                                   placeholder="Enter certificate number if exempt">
                        </div>
                    </div>
                    
                    <div>
                        <label class="input-label">Special Handling Instructions</label>
                        <textarea name="handling_instructions" 
                                 class="input-field"
                                 rows="3"
                                 placeholder="Enter any special handling instructions for customs clearance"></textarea>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end mt-12">
                    <button type="submit" 
                            class="arctic-button bg-deep-arctic text-white py-4 px-8 rounded-lg
                                  hover:bg-blue-700 transition-all duration-300 shadow-lg
                                  transform hover:-translate-y-1">
                        {% if current_user.is_admin() %}
                        Generate Import Documents
                        {% else %}
                            Submit for Review
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Templates for package and item details (reused from export shipment) -->
<template id="packageDetailsTemplate">
    <div class="arctic-card p-6" id="package_{packageNumber}">
        <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-deep-arctic">Package {packageNumber} of {totalPackages}</h4>
            <span class="bg-deep-arctic text-white px-3 py-1 rounded-full text-sm">#{packageNumber}</span>
        </div>
        
        <!-- Package Type Selection -->
        <div class="space-y-4 mb-6">
            <label class="input-label">Package Type</label>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <label class="cursor-pointer">
                    <input type="radio" 
                            name="package_{packageNumber}_type" 
                            value="cardboard_box" 
                            class="sr-only" 
                            checked>
                    <div class="radio-card arctic-card p-4 text-center">
                        <span class="text-2xl">üì¶</span>
                        <p class="mt-1">Cardboard Box</p>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" 
                            name="package_{packageNumber}_type" 
                            value="plastic_crate" 
                            class="sr-only">
                    <div class="radio-card arctic-card p-4 text-center">
                        <span class="text-2xl">üóÉÔ∏è</span>
                        <p class="mt-1">Plastic Crate</p>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" 
                            name="package_{packageNumber}_type" 
                            value="metal_trunk" 
                            class="sr-only">
                    <div class="radio-card arctic-card p-4 text-center">
                        <span class="text-2xl">üó≥Ô∏è</span>
                        <p class="mt-1">Metal Trunk</p>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" 
                            name="package_{packageNumber}_type" 
                            value="zarges" 
                            class="sr-only">
                    <div class="radio-card arctic-card p-4 text-center">
                        <span class="text-2xl">üß≥</span>
                        <p class="mt-1">Zarges</p>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" 
                            name="package_{packageNumber}_type" 
                            value="pelican_case" 
                            class="sr-only">
                    <div class="radio-card arctic-card p-4 text-center">
                        <span class="text-2xl">üíº</span>
                        <p class="mt-1">Pelican Case</p>
                    </div>
                </label>
                <label class="cursor-pointer">
                    <input type="radio" 
                            name="package_{packageNumber}_type" 
                            value="other" 
                            class="sr-only">
                    <div class="radio-card arctic-card p-4 text-center">
                        <span class="text-2xl">üìù</span>
                        <p class="mt-1">Other</p>
                    </div>
                </label>
            </div>
            <div class="other-type-input hidden">
                <input type="text" 
                        name="package_{packageNumber}_other_type" 
                        class="input-field mt-2"
                        placeholder="Specify package type">
            </div>
        </div>

        <!-- Package Dimensions -->
        <div class="space-y-2 mb-6">
            <label class="input-label">Package Dimensions (in cm)</label>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <input type="number" 
                            name="package_{packageNumber}_length" 
                            class="input-field"
                            placeholder="Length"
                            min="1" 
                            required>
                </div>
                <div>
                    <input type="number" 
                            name="package_{packageNumber}_width" 
                            class="input-field"
                            placeholder="Width"
                            min="1" 
                            required>
                </div>
                <div>
                    <input type="number" 
                            name="package_{packageNumber}_height" 
                            class="input-field"
                            placeholder="Height"
                            min="1" 
                            required>
                </div>
            </div>
        </div>

        <!-- Package Contents -->
        <div class="space-y-4">
            <div>
                <label class="input-label">Number of Items in Package</label>
                <input type="number" 
                        name="package_{packageNumber}_items_count" 
                        class="input-field package-items-count"
                        min="1"
                        placeholder="Enter number of items"
                        required>
            </div>
            
            <!-- Items Container -->
            <div class="items-container space-y-4">
                <!-- Items will be dynamically added here -->
            </div>
        </div>
    </div>
</template>

<!-- Item Template -->
<template id="itemDetailsTemplate">
    <div class="arctic-card p-4 border border-arctic-blue">
        <h5 class="font-semibold text-deep-arctic mb-4">
            Item {itemNumber} Details
        </h5>
        <div class="space-y-4">
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="input-label">Description of Goods</label>
                    <textarea name="{prefix}_description" 
                            class="input-field"
                            rows="2"
                            placeholder="Detailed description of item (include model/serial numbers if applicable)"
                            required></textarea>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div>
                    <label class="input-label">HSN</label>
                    <input type="text" 
                            name="{prefix}_hsn_code" 
                            class="input-field"
                            placeholder="e.g., 9015.80.90"
                            required>
                </div>
                <div>
                    <label class="input-label">Quantity</label>
                    <input type="number" 
                            name="{prefix}_quantity" 
                            class="input-field item-quantity"
                            min="1"
                            placeholder="Qty"
                            required
                            data-prefix="{prefix}">
                </div>
                <div>
                    <label class="input-label">Unit Value (USD)</label>
                    <input type="number" 
                            name="{prefix}_unit_value" 
                            class="input-field item-value"
                            min="0"
                            step="0.01"
                            placeholder="USD"
                            required
                            data-prefix="{prefix}">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="input-label">Net Weight (kg)</label>
                    <input type="number" 
                            name="{prefix}_net_weight" 
                            class="input-field item-weight"
                            min="0"
                            step="0.01"
                            placeholder="kg"
                            required
                            data-prefix="{prefix}">
                </div>
                <div>
                    <label class="input-label">Country of Origin</label>
                    <input type="text" 
                            name="{prefix}_origin" 
                            class="input-field"
                            placeholder="e.g., India"
                            required>
                </div>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
                <p class="font-medium text-deep-arctic">Item Total Value: 
                    <span id="{prefix}_total" class="item-total">0.00 USD</span>
                </p>
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date
    const today = new Date();
    const dateString = `${today.getDate().toString().padStart(2, '0')}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getFullYear()}`;
    document.getElementById('invoiceDateHidden').value = dateString;
    
    // Elements
    const totalPackagesInput = document.getElementById('totalPackagesInput');
    const packageDetailsContainer = document.getElementById('packageDetailsContainer');
    const packageDetailsTemplate = document.getElementById('packageDetailsTemplate');
    const itemDetailsTemplate = document.getElementById('itemDetailsTemplate');
    const packageSummary = document.getElementById('packageSummary');
    const requesterName = document.getElementById('requesterName');
    const expeditionYear = document.getElementById('expeditionYear');
    const batchNumber = document.getElementById('batchNumber');
    
    // Invoice number preview
    function updateInvoicePreview() {
        let firstName = 'FIRSTNAME';
        if (requesterName.value) {
            const nameParts = requesterName.value.trim().split(' ');
            // If we have title + first name (or more)
            if (nameParts.length > 1) {
                firstName = nameParts[1].toUpperCase(); // Take second word as first name
            } else {
                firstName = nameParts[0].toUpperCase(); // If only one word, use that
            }
        }
        const yearValue = expeditionYear.value || 'YYYY';
        const batchValue = batchNumber.value || 'BATCH';
        
        const invoiceNumber = `NCPOR/IMP/${yearValue}/RESEARCH/${batchValue}/${firstName}`;
        document.getElementById('invoiceNumberPreview').textContent = invoiceNumber;
    }
    
    // Add event listeners for preview updates
    requesterName.addEventListener('input', updateInvoicePreview);
    expeditionYear.addEventListener('input', updateInvoicePreview);
    batchNumber.addEventListener('input', updateInvoicePreview);
    
    // Initialize package type handlers
    function initializePackageTypeHandlers(packageElement) {
        const radioButtons = packageElement.querySelectorAll('input[type="radio"]');
        const otherTypeInput = packageElement.querySelector('.other-type-input');
        
        radioButtons.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'other') {
                    otherTypeInput.classList.remove('hidden');
                    otherTypeInput.querySelector('input').required = true;
                } else {
                    otherTypeInput.classList.add('hidden');
                    otherTypeInput.querySelector('input').required = false;
                }
            });
        });
    }
    
    // Function to calculate item totals
    function calculateItemTotal(prefix) {
        const quantityInput = document.querySelector(`[name="${prefix}_quantity"]`);
        const valueInput = document.querySelector(`[name="${prefix}_unit_value"]`);
        const totalElement = document.getElementById(`${prefix}_total`);
        
        if (quantityInput && valueInput && totalElement) {
            const quantity = parseInt(quantityInput.value) || 0;
            const value = parseFloat(valueInput.value) || 0;
            const total = quantity * value;
            
            totalElement.textContent = `${total.toFixed(2)} USD`;
        }
    }
    
    // Function to update all totals
    function updateTotals() {
        let totalItems = 0;
        let totalValue = 0;
        let totalWeight = 0;
        
        // Count all items
        document.querySelectorAll('.item-quantity').forEach(input => {
            totalItems += parseInt(input.value) || 0;
        });
        
        // Calculate total value
        document.querySelectorAll('.item-value, .item-quantity').forEach(input => {
            const prefix = input.dataset.prefix;
            if (prefix) {
                const quantityInput = document.querySelector(`[name="${prefix}_quantity"]`);
                const valueInput = document.querySelector(`[name="${prefix}_unit_value"]`);
                
                if (quantityInput && valueInput) {
                    const quantity = parseInt(quantityInput.value) || 0;
                    const value = parseFloat(valueInput.value) || 0;
                    totalValue += quantity * value;
                }
            }
        });
        
        // Calculate total weight
        document.querySelectorAll('.item-weight').forEach(input => {
            const weight = parseFloat(input.value) || 0;
            totalWeight += weight;
        });
        
        // Update summary
        document.getElementById('summaryTotalPackages').textContent = totalPackagesInput.value || 0;
        document.getElementById('summaryTotalItems').textContent = totalItems;
        document.getElementById('summaryGrossWeight').textContent = `${totalWeight.toFixed(2)} kg`;
        document.getElementById('summaryTotalValue').textContent = `${totalValue.toFixed(2)} USD`;
    }
    
    // Function to generate item details
    function generateItemDetails(packageNum, itemsCount, container) {
        container.innerHTML = '';
        
        for (let itemNum = 1; itemNum <= itemsCount; itemNum++) {
            const prefix = `package_${packageNum}_item_${itemNum}`;
            
            const itemHtml = itemDetailsTemplate.innerHTML
                .replaceAll('{itemNumber}', itemNum)
                .replaceAll('{prefix}', prefix);
            
            const itemElement = document.createElement('div');
            itemElement.innerHTML = itemHtml;
            container.appendChild(itemElement);
            
            // Add event listeners for calculations
            const inputs = container.querySelectorAll(`[data-prefix="${prefix}"]`);
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    calculateItemTotal(prefix);
                    updateTotals();
                });
            });
        }
    }
    
    // Function to generate package details
    function generatePackageDetails(totalPackages) {
        packageDetailsContainer.innerHTML = '';
        for (let packageNum = 1; packageNum <= totalPackages; packageNum++) {
            const packageHtml = packageDetailsTemplate.innerHTML
                .replaceAll('{packageNumber}', packageNum)
                .replaceAll('{totalPackages}', totalPackages);
            
            const packageElement = document.createElement('div');
            packageElement.innerHTML = packageHtml;
            packageDetailsContainer.appendChild(packageElement);
            
            // Initialize handlers for this package
            initializePackageTypeHandlers(packageElement);
            
            // Handle items count for this package
            const itemsCountInput = packageElement.querySelector('.package-items-count');
            const itemsContainer = packageElement.querySelector('.items-container');
            
            itemsCountInput.addEventListener('change', function() {
                const itemCount = parseInt(this.value) || 0;
                if (itemCount > 0) {
                    generateItemDetails(packageNum, itemCount, itemsContainer);
                    updateTotals();
                } else {
                    itemsContainer.innerHTML = '';
                    updateTotals();
                }
            });
        }
    }
    
    // Handle total packages input
    totalPackagesInput.addEventListener('change', function() {
        const totalPackages = parseInt(this.value) || 0;
        if (totalPackages > 0) {
            packageDetailsContainer.classList.remove('hidden');
            packageSummary.classList.remove('hidden');
            generatePackageDetails(totalPackages);
        } else {
            packageDetailsContainer.classList.add('hidden');
            packageSummary.classList.add('hidden');
        }
    });
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!form.checkValidity()) {
            // Find the first invalid input
            const firstInvalid = form.querySelector(':invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalid.focus();
            }
            return false;
        }
        
        // Additional validation
        const totalPackages = parseInt(totalPackagesInput.value) || 0;
        if (totalPackages === 0) {
            alert('Please enter at least one package');
            totalPackagesInput.focus();
            return false;
        }
        
        // All validations passed, submit the form
        this.submit();
    });
    
    // Initialize consigner selection
    const consignerHimadriRadio = document.getElementById('consignerHimadriRadio');
    const consignerOtherRadio = document.getElementById('consignerOtherRadio');
    const himadriConsignerDetails = document.getElementById('himadriConsignerDetails');
    const otherConsignerDetails = document.getElementById('otherConsignerDetails');

    // Function to toggle required fields
    function toggleRequiredFields(container, required) {
        const inputs = container.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.required = required;
        });
    }

    // Function to handle consigner selection
    function handleConsignerSelection() {
        if (consignerHimadriRadio.checked) {
            himadriConsignerDetails.classList.remove('hidden');
            otherConsignerDetails.classList.add('hidden');
            toggleRequiredFields(otherConsignerDetails, false);
        } else {
            himadriConsignerDetails.classList.add('hidden');
            otherConsignerDetails.classList.remove('hidden');
            toggleRequiredFields(otherConsignerDetails, true);
        }
    }

    // Add event listeners
    consignerHimadriRadio.addEventListener('change', handleConsignerSelection);
    consignerOtherRadio.addEventListener('change', handleConsignerSelection);
    
    // Initial setup
    handleConsignerSelection();
});

{% if edit_data and edit_data.is_editing %}
<script>
// Enhanced edit mode pre-filling for import/reimport - handles ALL form fields
document.addEventListener('DOMContentLoaded', function() {
    var editData = {{ edit_data | tojson | safe }};
    console.log('Import edit data:', editData);
    
    // Wait for form to be fully loaded
    setTimeout(function() {
        // Pre-fill basic fields
        if (editData.requester_name) {
            var requesterField = document.getElementById('requesterName');
            if (requesterField) requesterField.value = editData.requester_name;
        }
        
        if (editData.expedition_year) {
            var expeditionField = document.getElementById('expeditionYear');
            if (expeditionField) expeditionField.value = editData.expedition_year;
        }
        
        if (editData.batch_number) {
            var batchField = document.getElementById('batchNumber');
            if (batchField) batchField.value = editData.batch_number;
        }
        
        // Pre-fill import purpose
        if (editData.import_purpose) {
            var purposeRadio = document.querySelector(`input[name="import_purpose"][value="${editData.import_purpose}"]`);
            if (purposeRadio) {
                purposeRadio.checked = true;
                purposeRadio.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        
        // Pre-fill mode of import
        if (editData.import_mode) {
            var modeRadio = document.querySelector(`input[name="import_mode"][value="${editData.import_mode}"]`);
            if (modeRadio) {
                modeRadio.checked = true;
                modeRadio.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        
        // Pre-fill consigner selection
        if (editData.consigner) {
            var consignerRadio = document.querySelector(`input[name="consigner"][value="${editData.consigner}"]`);
            if (consignerRadio) {
                consignerRadio.checked = true;
                consignerRadio.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        
        // Pre-fill other consigner details if selected
        if (editData.consigner === 'other') {
            setTimeout(function() {
                if (editData.other_consigner_org) {
                    var field = document.querySelector('input[name="other_consigner_org"]');
                    if (field) field.value = editData.other_consigner_org;
                }
                if (editData.other_consigner_address) {
                    var field = document.querySelector('textarea[name="other_consigner_address"]');
                    if (field) field.value = editData.other_consigner_address;
                }
                if (editData.other_consigner_contact) {
                    var field = document.querySelector('input[name="other_consigner_contact"]');
                    if (field) field.value = editData.other_consigner_contact;
                }
                if (editData.other_consigner_designation) {
                    var field = document.querySelector('input[name="other_consigner_designation"]');
                    if (field) field.value = editData.other_consigner_designation;
                }
                if (editData.other_consigner_phone) {
                    var field = document.querySelector('input[name="other_consigner_phone"]');
                    if (field) field.value = editData.other_consigner_phone;
                }
                if (editData.other_consigner_email) {
                    var field = document.querySelector('input[name="other_consigner_email"]');
                    if (field) field.value = editData.other_consigner_email;
                }
            }, 500);
        }
        
        // Pre-fill total packages and generate package fields
        if (editData.total_packages) {
            var totalPackagesField = document.getElementById('totalPackagesInput');
            if (totalPackagesField) {
                totalPackagesField.value = editData.total_packages;
                totalPackagesField.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Wait for packages to be generated, then fill them
                setTimeout(function() {
                    fillImportPackageData(editData);
                }, 1000);
            }
        }
        
        // Update invoice number preview
        updateInvoiceNumber();
    }, 500);
});

function fillImportPackageData(editData) {
    var totalPackages = parseInt(editData.total_packages || 0);
    
    for (var packageNum = 1; packageNum <= totalPackages; packageNum++) {
        // Fill package type
        var packageTypeKey = `package_${packageNum}_type`;
        if (editData[packageTypeKey]) {
            var typeRadio = document.querySelector(`input[name="package_${packageNum}_type"][value="${editData[packageTypeKey]}"]`);
            if (typeRadio) {
                typeRadio.checked = true;
                typeRadio.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        
        // Fill other package type if applicable
        var otherTypeKey = `package_${packageNum}_other_type`;
        if (editData[otherTypeKey]) {
            var otherTypeField = document.querySelector(`input[name="${otherTypeKey}"]`);
            if (otherTypeField) otherTypeField.value = editData[otherTypeKey];
        }
        
        // Fill package dimensions
        var lengthField = document.querySelector(`input[name="package_${packageNum}_length"]`);
        if (lengthField && editData[`package_${packageNum}_length`]) {
            lengthField.value = editData[`package_${packageNum}_length`];
        }
        
        var widthField = document.querySelector(`input[name="package_${packageNum}_width"]`);
        if (widthField && editData[`package_${packageNum}_width`]) {
            widthField.value = editData[`package_${packageNum}_width`];
        }
        
        var heightField = document.querySelector(`input[name="package_${packageNum}_height"]`);
        if (heightField && editData[`package_${packageNum}_height`]) {
            heightField.value = editData[`package_${packageNum}_height`];
        }
        
        // Fill items count and generate items
        var itemsCountKey = `package_${packageNum}_items_count`;
        if (editData[itemsCountKey]) {
            var itemsCountField = document.querySelector(`input[name="${itemsCountKey}"]`);
            if (itemsCountField) {
                itemsCountField.value = editData[itemsCountKey];
                itemsCountField.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Wait for items to be generated, then fill them
                setTimeout(function(pkgNum) {
                    return function() {
                        fillImportItemsData(editData, pkgNum);
                    };
                }(packageNum), 500);
            }
        }
    }
}

function fillImportItemsData(editData, packageNum) {
    var itemsCount = parseInt(editData[`package_${packageNum}_items_count`] || 0);
    
    for (var itemNum = 1; itemNum <= itemsCount; itemNum++) {
        var prefix = `package_${packageNum}_item_${itemNum}`;
        
        // Fill item description
        var descField = document.querySelector(`textarea[name="${prefix}_description"]`);
        if (descField && editData[`${prefix}_description`]) {
            descField.value = editData[`${prefix}_description`];
        }
        
        // Fill HSN code
        var hsnField = document.querySelector(`input[name="${prefix}_hsn_code"]`);
        if (hsnField && editData[`${prefix}_hsn_code`]) {
            hsnField.value = editData[`${prefix}_hsn_code`];
        }
        
        // Fill quantity
        var qtyField = document.querySelector(`input[name="${prefix}_quantity"]`);
        if (qtyField && editData[`${prefix}_quantity`]) {
            qtyField.value = editData[`${prefix}_quantity`];
            qtyField.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Fill unit value
        var valueField = document.querySelector(`input[name="${prefix}_unit_value"]`);
        if (valueField && editData[`${prefix}_unit_value`]) {
            valueField.value = editData[`${prefix}_unit_value`];
            valueField.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Fill gross weight
        var weightField = document.querySelector(`input[name="${prefix}_net_weight"]`);
        if (weightField && editData[`${prefix}_net_weight`]) {
            weightField.value = editData[`${prefix}_net_weight`];
            weightField.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Fill country of origin
        var originField = document.querySelector(`input[name="${prefix}_origin"]`);
        if (originField && editData[`${prefix}_origin`]) {
            originField.value = editData[`${prefix}_origin`];
        }
    }
    
    // Update totals after filling all data
    setTimeout(updateTotals, 200);
}
</script>
{% endif %}
{% endblock %} 