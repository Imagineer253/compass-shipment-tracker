{% extends "base.html" %}

{% block title %}NCPOR Arctic Research Dashboard{% endblock %}

{% block content %}
<!-- Compact Hero Section -->
<div id="weatherHero" class="weather-background text-white py-6 -mx-4 -mt-20 mb-6 relative overflow-hidden transition-all duration-1000">
    <!-- Dynamic Weather Overlay -->
    <div id="weatherOverlay" class="absolute inset-0 transition-all duration-1000"></div>
    
    <!-- Weather Particles Container -->
    <div id="weatherParticles" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
    
    <div class="max-w-7xl mx-auto px-4 pt-16 relative z-10">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
            <!-- Logo and Title - Compact -->
            <div class="lg:col-span-1 text-center lg:text-left">
                <div class="flex items-center justify-center lg:justify-start mb-4">
                    <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mr-4 backdrop-blur-sm">
                        <i class="fas fa-globe-americas text-2xl text-white"></i>
            </div>
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold text-white drop-shadow-lg">COMPASS</h1>
                        <h2 class="text-lg font-semibold text-white/90 drop-shadow-md">Arctic Research Dashboard</h2>
        </div>
                    </div>
                <p class="text-sm text-white/80 drop-shadow-md">15th Indian Arctic Expedition</p>
                    </div>
            <!-- Compact Weather Info -->
            <div class="lg:col-span-1 weather-info-card bg-white/10 rounded-xl p-4">
                <div class="flex items-center mb-3">
                    <i class="fas fa-map-marker-alt mr-2 text-white/80"></i>
                    <span class="text-white font-semibold text-sm">Ny-Ålesund, Svalbard</span>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-center mb-3">
                    <div class="bg-white/10 rounded-lg p-2">
                        <div id="temperature" class="text-lg font-bold text-white">--°C</div>
                        <div class="text-white/70 text-xs">Temp</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <div id="windSpeed" class="text-lg font-bold text-white">-- km/h</div>
                        <div class="text-white/70 text-xs">Wind</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <div id="humidity" class="text-lg font-bold text-white">--%</div>
                        <div class="text-white/70 text-xs">Humidity</div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-2">
                        <div id="pressure" class="text-lg font-bold text-white">-- hPa</div>
                        <div class="text-white/70 text-xs">Pressure</div>
                    </div>
                </div>
                
                <div class="text-center">
                    <div class="flex items-center justify-center mb-2">
                        <i id="weatherIcon" class="fas fa-cloud text-2xl text-white mr-2"></i>
                        <div id="weatherDescription" class="text-white text-sm font-medium">Loading...</div>
                    </div>
                    <div id="windDirection" class="text-white/70 text-xs mt-1">Wind: --</div>
                    <div id="precipitation" class="text-white/70 text-xs mt-1" style="display: none;">Precipitation: --</div>
                    <div id="lastUpdated" class="text-white/70 text-xs mt-1">Loading weather...</div>
                    <div id="dataSource" class="text-white/50 text-xs mt-1">Data source: --</div>
                </div>
            </div>
            
            <!-- Quick Actions & Status -->
            <div class="lg:col-span-1 space-y-3">
                {% if current_user.is_authenticated %}
                <div class="bg-white/10 rounded-xl p-4">
                    <div class="text-white/90 text-sm mb-3">
                    <i class="fas fa-user-check mr-2"></i>
                        Welcome, <strong>{{ current_user.first_name }}</strong>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <a href="{{ url_for('main.shipment_type_selection') }}" 
                           class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-2 px-3 rounded-lg flex items-center justify-center transition-all duration-300">
                            <i class="fas fa-box mr-1"></i>
                            Shipment
                        </a>
                        <a href="{{ url_for('main.dashboard') }}" 
                           class="bg-purple-500 hover:bg-purple-600 text-white text-xs font-semibold py-2 px-3 rounded-lg flex items-center justify-center transition-all duration-300">
                            <i class="fas fa-tachometer-alt mr-1"></i>
                            Dashboard
                        </a>
                    </div>
                </div>
                {% endif %}
                
                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-3 py-2 rounded-lg font-semibold text-xs flex items-center justify-center">
                    <i class="fas fa-cloud-sun mr-2"></i>
                    Live Weather Demo
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optimized Main Content Layout -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
    
    <!-- Compact Statistics Panel -->
    <div class="lg:col-span-1">
        <div class="arctic-card p-4 bg-gradient-to-br from-blue-50 to-cyan-50 border-l-4 border-blue-500">
            <div class="flex items-center mb-3">
                <div class="bg-blue-500 rounded-lg p-2 mr-2">
                    <i class="fas fa-chart-line text-white"></i>
                </div>
                <h3 class="text-lg font-bold text-deep-arctic">Mission Stats</h3>
                </div>
            
            <div class="grid grid-cols-2 gap-2 mb-3">
                <div class="bg-white p-3 rounded-lg text-center shadow-sm">
                    <div class="text-xl mb-1 text-blue-500"><i class="fas fa-microscope"></i></div>
                    <div class="text-lg font-bold text-deep-arctic">12</div>
                    <div class="text-xs text-gray-600">Projects</div>
                </div>
                <div class="bg-white p-3 rounded-lg text-center shadow-sm">
                    <div class="text-xl mb-1 text-green-500"><i class="fas fa-university"></i></div>
                    <div class="text-lg font-bold text-deep-arctic">15</div>
                    <div class="text-xs text-gray-600">Institutes</div>
                </div>
                <div class="bg-white p-3 rounded-lg text-center shadow-sm">
                    <div class="text-xl mb-1 text-purple-500"><i class="fas fa-users"></i></div>
                    <div class="text-lg font-bold text-deep-arctic">25</div>
                    <div class="text-xs text-gray-600">People</div>
                    </div>
                <div class="bg-white p-3 rounded-lg text-center shadow-sm">
                    <div class="text-xl mb-1 text-orange-500"><i class="fas fa-database"></i></div>
                    <div class="text-lg font-bold text-deep-arctic">247</div>
                    <div class="text-xs text-gray-600">Samples</div>
                </div>
                    </div>

            <!-- Compact Status Indicators -->
            <div class="border-t pt-2">
                <h4 class="text-xs font-semibold text-gray-700 mb-2">System Status</h4>
                <div class="space-y-1 text-xs">
                    <div class="flex items-center justify-between">
                        <span>Logistics</span>
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                </div>
                    <div class="flex items-center justify-between">
                        <span>Data Collection</span>
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Weather Monitor</span>
                        <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
            </div>
                </div>
                </div>
                </div>

        <!-- Compact Research Stations & Controls -->
        <div class="space-y-3">
            <div class="arctic-card p-3 bg-gradient-to-br from-gray-50 to-blue-50">
                <div class="flex items-center mb-2">
                    <div class="bg-gray-600 rounded-lg p-1 mr-2">
                        <i class="fas fa-map-marked-alt text-white text-sm"></i>
                </div>
                    <h4 class="text-sm font-bold text-deep-arctic">Research Stations</h4>
                </div>
            
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div class="flex items-center justify-between p-2 bg-white rounded shadow-sm">
                    <div class="flex items-center">
                            <i class="fas fa-water text-blue-600 mr-1"></i>
                            <span>CTD</span>
                        </div>
                        <span class="bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs">3</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-white rounded shadow-sm">
                    <div class="flex items-center">
                            <i class="fas fa-snowflake text-cyan-600 mr-1"></i>
                            <span>Ice</span>
                        </div>
                        <span class="bg-cyan-100 text-cyan-800 px-1 py-0.5 rounded text-xs">3</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-white rounded shadow-sm">
                    <div class="flex items-center">
                            <i class="fas fa-mountain text-yellow-600 mr-1"></i>
                            <span>Sediment</span>
                        </div>
                        <span class="bg-yellow-100 text-yellow-800 px-1 py-0.5 rounded text-xs">2</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-white rounded shadow-sm">
                    <div class="flex items-center">
                            <i class="fas fa-tint text-green-600 mr-1"></i>
                            <span>Water</span>
                        </div>
                        <span class="bg-green-100 text-green-800 px-1 py-0.5 rounded text-xs">3</span>
                    </div>
            </div>
        </div>

            <!-- Compact Map Controls -->
            <div class="arctic-card p-3">
                <h4 class="text-sm font-bold text-deep-arctic mb-2">🎛️ Map Controls</h4>
                <div class="grid grid-cols-1 gap-1">
                    <button id="toggleLayers" class="arctic-button text-xs py-1.5 hover:transform hover:scale-105 transition-all">
                        Toggle Stations
                </button>
                    <button id="satelliteView" class="arctic-button text-xs py-1.5 hover:transform hover:scale-105 transition-all">
                    Satellite View
                </button>
                    <button id="resetView" class="arctic-button text-xs py-1.5 hover:transform hover:scale-105 transition-all">
                        Reset View
                </button>
                </div>
            </div>
        </div>

        <!-- Compact User Panel -->
        {% if current_user.is_authenticated %}
        <div class="arctic-card p-3 bg-gradient-to-br from-green-50 to-emerald-50 border-l-4 border-green-500">
            <div class="flex items-center mb-2">
                <div class="bg-green-500 rounded-lg p-1 mr-2">
                    <i class="fas fa-rocket text-white text-sm"></i>
                </div>
                <h4 class="text-sm font-bold text-deep-arctic">Quick Actions</h4>
            </div>
            
            <div class="grid grid-cols-1 gap-2">
                <a href="{{ url_for('main.shipment_type_selection') }}" 
                   class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg flex items-center justify-center transition-all duration-300 text-xs">
                    <i class="fas fa-box mr-1"></i>
                    Create Shipment
                </a>
                <a href="{{ url_for('main.dashboard') }}" 
                   class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg flex items-center justify-center transition-all duration-300 text-xs">
                    <i class="fas fa-tachometer-alt mr-1"></i>
                    Dashboard
                </a>
                {% if current_user.is_admin() %}
                <a href="{{ url_for('main.admin_users') }}" 
                   class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-3 rounded-lg flex items-center justify-center transition-all duration-300 text-xs">
                    <i class="fas fa-users-cog mr-1"></i>
                    Admin Panel
                </a>
                {% endif %}
            </div>
            
            <!-- Compact User Info -->
            <div class="mt-2 pt-2 border-t border-green-200">
                <div class="flex items-center text-xs text-gray-600">
                    <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white font-bold mr-2 text-xs">
                        {{ current_user.first_name[:1] }}{{ current_user.last_name[:1] }}
                    </div>
                    <div>
                        <div class="font-medium text-gray-800 text-xs">{{ current_user.first_name }}</div>
                        <div class="text-xs text-gray-500">{{ current_user.organization or 'COMPASS' }}</div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Compact Guest Info -->
        <div class="arctic-card p-3 bg-gradient-to-br from-blue-50 to-indigo-50 border-l-4 border-blue-500">
            <div class="flex items-center mb-2">
                <div class="bg-blue-500 rounded-lg p-1 mr-2">
                    <i class="fas fa-info-circle text-white text-sm"></i>
                </div>
                <h4 class="text-sm font-bold text-deep-arctic">System Access</h4>
            </div>
            
            <div class="space-y-1 text-xs text-gray-700">
                <div><i class="fas fa-lock mr-1 text-blue-500"></i> Login required</div>
                <div><i class="fas fa-chart-line mr-1 text-green-500"></i> Live research data</div>
                <div><i class="fas fa-globe mr-1 text-purple-500"></i> Interactive map</div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Optimized Map Section -->
    <div class="lg:col-span-3">
        <div class="arctic-card p-3 h-full flex flex-col">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center">
                    <div class="bg-blue-500 rounded-lg p-2 mr-2">
                        <i class="fas fa-globe-americas text-white"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-deep-arctic">Arctic Research Map</h3>
                        <p class="text-xs text-gray-600">Svalbard, Norway - Live Locations</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold text-blue-600">
                        <span id="stationCount">13</span>
                    </div>
                    <div class="text-xs text-gray-500">Active Stations</div>
                </div>
            </div>
            
            <!-- Optimized Map Container -->
            <div id="arcticMap" class="w-full rounded-lg border-2 border-gray-200 shadow-lg flex-1"></div>
            
            <!-- Compact Status Bar -->
            <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
                <span>Click markers for details</span>
                <span id="mapStatus">Map loaded</span>
            </div>
        </div>
    </div>
</div>

<!-- Compact Personnel Section -->
<div class="arctic-card p-4 mb-4">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-deep-arctic">👥 Current Personnel in Arctic</h3>
        <div class="text-sm text-gray-500">
            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">15 Active Researchers</span>
        </div>
    </div>
    
    <!-- Compact Personnel Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-3">
        
        <!-- Team Leader -->
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-3 rounded-lg border-l-4 border-blue-500 transition-all duration-300">
            <div class="flex items-center mb-2">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold mr-2 text-xs">
                    SK
                </div>
                <div>
                    <h4 class="font-bold text-deep-arctic text-sm">Dr. S. Kumar</h4>
                    <p class="text-xs text-blue-700 font-medium">Expedition Leader</p>
                </div>
            </div>
            <p class="text-xs text-gray-600 mb-1">🏛️ NCPOR, Goa</p>
            <p class="text-xs text-gray-500">Himadri Station</p>
            <div class="mt-1 flex space-x-1">
                <span class="bg-blue-200 text-blue-800 px-1 py-0.5 rounded text-xs">Glaciology</span>
            </div>
        </div>

        <!-- Ice Researcher -->
        <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 p-3 rounded-lg border-l-4 border-cyan-500 transition-all duration-300">
            <div class="flex items-center mb-2">
                <div class="w-8 h-8 bg-cyan-500 rounded-full flex items-center justify-center text-white font-bold mr-2 text-xs">
                    AM
                </div>
                <div>
                    <h4 class="font-bold text-deep-arctic text-sm">Dr. A. Mahajan</h4>
                    <p class="text-xs text-cyan-700 font-medium">Ice Core Specialist</p>
                </div>
            </div>
            <p class="text-xs text-gray-600 mb-1">🏛️ IITB, Mumbai</p>
            <p class="text-xs text-gray-500">Sea Ice Station Alpha</p>
            <div class="mt-1 flex space-x-1">
                <span class="bg-cyan-200 text-cyan-800 px-1 py-0.5 rounded text-xs">Ice Physics</span>
            </div>
        </div>

        <!-- Oceanographer -->
        <div class="bg-gradient-to-br from-teal-50 to-teal-100 p-3 rounded-lg border-l-4 border-teal-500 transition-all duration-300">
            <div class="flex items-center mb-2">
                <div class="w-8 h-8 bg-teal-500 rounded-full flex items-center justify-center text-white font-bold mr-2 text-xs">
                    RS
                </div>
                <div>
                    <h4 class="font-bold text-deep-arctic text-sm">Dr. R. Sharma</h4>
                    <p class="text-xs text-teal-700 font-medium">Oceanographer</p>
                </div>
            </div>
            <p class="text-xs text-gray-600 mb-1">🏛️ NIOT, Chennai</p>
            <p class="text-xs text-gray-500">Kongsfjorden CTD</p>
            <div class="mt-1 flex space-x-1">
                <span class="bg-teal-200 text-teal-800 px-1 py-0.5 rounded text-xs">Ocean</span>
            </div>
        </div>

        <!-- Atmospheric Scientist -->
        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-3 rounded-lg border-l-4 border-purple-500 transition-all duration-300">
            <div class="flex items-center mb-2">
                <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center text-white font-bold mr-2 text-xs">
                    PK
                </div>
                <div>
                    <h4 class="font-bold text-deep-arctic text-sm">Dr. P. Kapoor</h4>
                    <p class="text-xs text-purple-700 font-medium">Atmospheric</p>
                </div>
            </div>
            <p class="text-xs text-gray-600 mb-1">🏛️ IITD, Delhi</p>
            <p class="text-xs text-gray-500">Himadri Station</p>
            <div class="mt-1 flex space-x-1">
                <span class="bg-purple-200 text-purple-800 px-1 py-0.5 rounded text-xs">Aerosols</span>
            </div>
        </div>

        <!-- Marine Biologist -->
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-3 rounded-lg border-l-4 border-green-500 transition-all duration-300">
            <div class="flex items-center mb-2">
                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold mr-2 text-xs">
                    VT
                </div>
                <div>
                    <h4 class="font-bold text-deep-arctic text-sm">Dr. V. Tiwari</h4>
                    <p class="text-xs text-green-700 font-medium">Marine Biologist</p>
                </div>
            </div>
            <p class="text-xs text-gray-600 mb-1">🏛️ CAS, Goa</p>
            <p class="text-xs text-gray-500">Surface Water Station</p>
            <div class="mt-1 flex space-x-1">
                <span class="bg-green-200 text-green-800 px-1 py-0.5 rounded text-xs">Biology</span>
            </div>
        </div>

        <!-- Show More Button (Optional - for extensibility) -->
        <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-3 rounded-lg border-2 border-dashed border-gray-300 transition-all duration-300 flex items-center justify-center">
            <div class="text-center">
                <div class="text-gray-400 mb-1">
                    <i class="fas fa-plus-circle text-lg"></i>
                </div>
                <p class="text-xs text-gray-500">+10 More</p>
                <p class="text-xs text-gray-400">Researchers</p>
            </div>
        </div>

    </div>
    
    <!-- Compact Personnel Summary -->
    <div class="mt-3 p-3 bg-gray-50 rounded-lg">
        <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold text-deep-arctic text-sm">📊 Team Statistics</h4>
            <span class="text-xs text-gray-500">Live Data</span>
            </div>
        <div class="grid grid-cols-4 gap-2 text-center">
            <div class="bg-white p-2 rounded">
                <div class="text-lg font-bold text-blue-600">15</div>
                <div class="text-xs text-gray-600">Personnel</div>
            </div>
            <div class="bg-white p-2 rounded">
                <div class="text-lg font-bold text-green-600">8</div>
                <div class="text-xs text-gray-600">Institutes</div>
            </div>
            <div class="bg-white p-2 rounded">
                <div class="text-lg font-bold text-purple-600">6</div>
                <div class="text-xs text-gray-600">Fields</div>
            </div>
            <div class="bg-white p-2 rounded">
                <div class="text-lg font-bold text-orange-600">45</div>
                <div class="text-xs text-gray-600">Days</div>
        </div>
        </div>
        <div class="mt-2 text-xs text-gray-600">
            <p><strong>Teams:</strong> NIO, INCOIS, IISC, JNU, Kashmir Uni, BHU, Cochin, Delhi & more across Arctic stations</p>
        </div>
    </div>
</div>

<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Font Awesome for better icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
// Weather API Configuration
const WEATHER_API_KEY = '7aa96b4042934e878b3133936241612'; // WeatherAPI.com key (fallback)
const NY_ALESUND_COORDS = { lat: 78.9249, lon: 11.9303 };
const YR_NO_API_URL = 'https://api.met.no/weatherapi/locationforecast/2.0/compact';
const YR_NO_NOWCAST_URL = 'https://api.met.no/weatherapi/nowcast/2.0/complete';

// Weather background configurations
const weatherBackgrounds = {
    clear: {
        gradient: 'linear-gradient(135deg, #4682B4 0%, #5F9EA0 50%, #87CEEB 100%)',
        backgroundType: 'clear',
        hasParticles: true,
        particles: '☀️',
        particleCount: 1,
        animationType: 'sun'
    },
    sunny: {
        gradient: 'linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%)',
        backgroundType: 'sunny',
        hasParticles: true,
        particles: '☀️',
        particleCount: 1,
        animationType: 'sun'
    },
    cloudy: {
        gradient: 'linear-gradient(135deg, #708090 0%, #778899 50%, #87CEEB 100%)',
        backgroundType: 'cloudy',
        hasParticles: false
    },
    overcast: {
        gradient: 'linear-gradient(135deg, #696969 0%, #778899 50%, #B0C4DE 100%)',
        backgroundType: 'overcast',
        hasParticles: false
    },
    rain: {
        gradient: 'linear-gradient(135deg, #4682B4 0%, #5F9EA0 50%, #708090 100%)',
        backgroundType: 'rain',
        hasParticles: true,
        particles: '💧',
        particleCount: 15,
        animationType: 'fall'
    },
    snow: {
        gradient: 'linear-gradient(135deg, #2C3E50 0%, #34495E 30%, #5D6D7E 70%, #85929E 100%)',
        backgroundType: 'snow',
        hasParticles: true,
        particles: '❄️',
        particleCount: 20,
        animationType: 'fall'
    },
    storm: {
        gradient: 'linear-gradient(135deg, #2F4F4F 0%, #483D8B 50%, #191970 100%)',
        backgroundType: 'storm',
        hasParticles: true,
        particles: '💧',
        particleCount: 12,
        animationType: 'fall'
    },
    fog: {
        gradient: 'linear-gradient(135deg, #DCDCDC 0%, #C0C0C0 50%, #A9A9A9 100%)',
        backgroundType: 'fog',
        hasParticles: false
    },
    wind: {
        gradient: 'linear-gradient(135deg, #B0E0E6 0%, #87CEEB 50%, #4682B4 100%)',
        backgroundType: 'wind',
        hasParticles: false
    }
};

// Fetch weather data with Yr.no as primary (official Norwegian weather service)
async function fetchWeatherData() {
    try {
        // Try Yr.no via our server proxy (to avoid CORS issues)
        console.log('Fetching weather from Yr.no via server proxy...');
        
        const proxyResponse = await fetch(
            `/api/weather-proxy?lat=${NY_ALESUND_COORDS.lat}&lon=${NY_ALESUND_COORDS.lon}`,
            {
                method: 'GET',
                cache: 'default'
            }
        );
        
        console.log('Proxy response status:', proxyResponse.status, proxyResponse.statusText);
        
        if (proxyResponse.ok) {
            const proxyData = await proxyResponse.json();
            console.log('Proxy response received:', proxyData.success ? 'Success' : 'Failed');
            
            if (proxyData.success && proxyData.data) {
                console.log('Yr.no data structure:', {
                    hasProperties: !!proxyData.data.properties,
                    hasTimeseries: !!(proxyData.data.properties && proxyData.data.properties.timeseries),
                    timeseriesLength: proxyData.data.properties && proxyData.data.properties.timeseries ? proxyData.data.properties.timeseries.length : 0
                });
                
                const processedData = processYrNoData(proxyData.data, false);
                updateWeatherDisplay(processedData, proxyData.source || 'Yr.no (Norwegian Met Institute)');
            updateWeatherBackground(processedData);
                console.log('Weather updated successfully from Yr.no via proxy');
            return;
            } else {
                console.error('Proxy returned error:', proxyData.error);
            }
        } else {
            console.error('Proxy request failed with status:', proxyResponse.status);
            const errorText = await proxyResponse.text();
            console.error('Proxy error response:', errorText);
        }
        
        // Fallback to WeatherAPI.com if Yr.no fails
        console.log('Yr.no failed, trying WeatherAPI.com...');
        const weatherResponse = await fetch(`https://api.weatherapi.com/v1/current.json?key=${WEATHER_API_KEY}&q=${NY_ALESUND_COORDS.lat},${NY_ALESUND_COORDS.lon}&aqi=no`);
        
        if (weatherResponse.ok) {
            const weatherData = await weatherResponse.json();
            console.log('WeatherAPI data received:', weatherData);
            
            // Use WeatherAPI data directly (it's already in the right format)
            const processedData = {
                current: {
                    temp_c: Math.round(weatherData.current.temp_c),
                    wind_kph: Math.round(weatherData.current.wind_kph),
                    humidity: weatherData.current.humidity,
                    pressure_mb: Math.round(weatherData.current.pressure_mb),
                    condition: {
                        text: weatherData.current.condition.text,
                        icon: weatherData.current.condition.icon
                    },
                    wind_dir: weatherData.current.wind_dir,
                    cloud_cover: weatherData.current.cloud,
                    visibility: weatherData.current.vis_km * 1000 // Convert km to meters
                },
                location: { 
                    localtime: weatherData.location.localtime,
                    name: weatherData.location.name,
                    country: weatherData.location.country
                }
            };
            
            updateWeatherDisplay(processedData, 'WeatherAPI.com (Fallback)');
            updateWeatherBackground(processedData);
            console.log('Weather updated successfully from WeatherAPI');
            return;
        }
        
        throw new Error('All weather APIs failed');
        
    } catch (error) {
        console.error('Failed to fetch weather data:', error);
        console.error('Error details:', {
            name: error.name,
            message: error.message,
            stack: error.stack
        });
        
        // Use current realistic Arctic winter conditions
        const now = new Date();
        const fallbackData = {
            current: {
                temp_c: -15, // Typical winter temperature
                wind_kph: 25, // Moderate Arctic wind
                humidity: 85, // High humidity common in Arctic
                pressure_mb: 1015, // Typical sea level pressure
                condition: { 
                    text: 'Overcast', 
                    icon: '//cdn.weatherapi.com/weather/64x64/day/119.png' 
                },
                wind_dir: 'NW', // Prevailing wind direction
                cloud_cover: 80,
                visibility: 8000
            },
            location: { 
                localtime: now.toISOString(),
                name: 'Ny-Ålesund',
                country: 'Norway'
            }
        };
        
        updateWeatherBackground(fallbackData);
        updateWeatherDisplay(fallbackData, 'Fallback Data (APIs Failed)');
        console.log('Using fallback weather data due to API failures');
    }
}

// Test function to debug Yr.no API access via proxy
async function testYrNoAPI() {
    try {
        console.log('Testing Yr.no API access via proxy...');
        const testUrl = `/api/weather-proxy?lat=${NY_ALESUND_COORDS.lat}&lon=${NY_ALESUND_COORDS.lon}`;
        console.log('Test URL:', testUrl);
        
        const response = await fetch(testUrl, {
            method: 'GET'
        });
        
        console.log('Test response status:', response.status);
        console.log('Test response headers:', Object.fromEntries(response.headers));
        
        if (response.ok) {
            const data = await response.json();
            console.log('Test response:', data);
            
            if (data.success && data.data) {
                console.log('Test successful - received data structure:', {
                    hasProperties: !!data.data.properties,
                    hasTimeseries: !!(data.data.properties && data.data.properties.timeseries),
                    timeseriesLength: data.data.properties && data.data.properties.timeseries ? data.data.properties.timeseries.length : 0
                });
                return true;
            } else {
                console.error('Test failed - proxy returned error:', data.error);
                return false;
            }
        } else {
            const errorText = await response.text();
            console.error('Test failed with error:', errorText);
            return false;
        }
    } catch (error) {
        console.error('Test failed with exception:', error);
        return false;
    }
}

// Add test button for debugging (can be called from browser console)
window.testWeather = testYrNoAPI;

// Process Yr.no API data to match our expected format
function processYrNoData(yrData, isNowcast = false) {
    try {
        if (!yrData.properties || !yrData.properties.timeseries || yrData.properties.timeseries.length === 0) {
            throw new Error('Invalid Yr.no data structure');
        }
        
        const current = yrData.properties.timeseries[0].data.instant.details;
        const next1h = yrData.properties.timeseries[0].data.next_1_hours;
        const next6h = yrData.properties.timeseries[0].data.next_6_hours;
        
        // Get weather symbol from appropriate timeframe
        let weatherSymbol = 'cloudy';
        if (isNowcast && next1h && next1h.summary) {
            weatherSymbol = next1h.summary.symbol_code;
        } else if (next6h && next6h.summary) {
            weatherSymbol = next6h.summary.symbol_code;
        } else if (next1h && next1h.summary) {
            weatherSymbol = next1h.summary.symbol_code;
        }
        
        // Comprehensive Norwegian weather symbol mapping
    let condition = 'Cloudy';
    
        if (weatherSymbol.includes('clearsky')) {
            condition = 'Clear';
        } else if (weatherSymbol.includes('fair')) {
            condition = 'Fair';
        } else if (weatherSymbol.includes('partlycloudy')) {
            condition = 'Partly cloudy';
        } else if (weatherSymbol.includes('cloudy')) {
            condition = 'Cloudy';
        } else if (weatherSymbol.includes('fog')) {
            condition = 'Fog';
        } else if (weatherSymbol.includes('lightrainshowersandthunder') || weatherSymbol.includes('lightrain') && weatherSymbol.includes('thunder')) {
            condition = 'Light rain with thunder';
        } else if (weatherSymbol.includes('lightrainshowers') || weatherSymbol.includes('lightrain')) {
            condition = 'Light rain';
        } else if (weatherSymbol.includes('rainshowersandthunder') || weatherSymbol.includes('rain') && weatherSymbol.includes('thunder')) {
            condition = 'Rain with thunder';
        } else if (weatherSymbol.includes('rainshowers') || weatherSymbol.includes('rain')) {
            condition = 'Rain';
        } else if (weatherSymbol.includes('heavyrainshowersandthunder') || weatherSymbol.includes('heavyrain') && weatherSymbol.includes('thunder')) {
            condition = 'Heavy rain with thunder';
        } else if (weatherSymbol.includes('heavyrainshowers') || weatherSymbol.includes('heavyrain')) {
            condition = 'Heavy rain';
        } else if (weatherSymbol.includes('lightsleetshowers') || weatherSymbol.includes('lightsleet')) {
            condition = 'Light sleet';
        } else if (weatherSymbol.includes('sleetshowers') || weatherSymbol.includes('sleet')) {
            condition = 'Sleet';
        } else if (weatherSymbol.includes('heavysleetshowers') || weatherSymbol.includes('heavysleet')) {
            condition = 'Heavy sleet';
        } else if (weatherSymbol.includes('lightsnowshowersandthunder') || weatherSymbol.includes('lightsnow') && weatherSymbol.includes('thunder')) {
            condition = 'Light snow with thunder';
        } else if (weatherSymbol.includes('lightsnowshowers') || weatherSymbol.includes('lightsnow')) {
            condition = 'Light snow';
        } else if (weatherSymbol.includes('snowshowersandthunder') || weatherSymbol.includes('snow') && weatherSymbol.includes('thunder')) {
            condition = 'Snow with thunder';
        } else if (weatherSymbol.includes('snowshowers') || weatherSymbol.includes('snow')) {
            condition = 'Snow';
        } else if (weatherSymbol.includes('heavysnowshowersandthunder') || weatherSymbol.includes('heavysnow') && weatherSymbol.includes('thunder')) {
            condition = 'Heavy snow with thunder';
        } else if (weatherSymbol.includes('heavysnowshowers') || weatherSymbol.includes('heavysnow')) {
            condition = 'Heavy snow';
        }
        
        // Get precipitation amount if available (for nowcast)
        let precipitationAmount = 0;
        if (isNowcast && next1h && next1h.details && next1h.details.precipitation_amount) {
            precipitationAmount = next1h.details.precipitation_amount;
        }
        
        // Get cloud cover and visibility data with validation
        const cloudCover = Math.min(100, Math.max(0, current.cloud_area_fraction || 0)); // 0-100%
        const visibility = Math.max(0, current.visibility || 10000); // meters
        
        // Validate temperature (Arctic conditions: -50°C to +20°C reasonable range)
        let temperature = current.air_temperature;
        if (temperature === undefined || temperature < -50 || temperature > 20) {
            temperature = -12; // Reasonable winter default
        }
        
        // Validate wind speed (convert m/s to km/h, max reasonable ~200 km/h)
        let windSpeed = current.wind_speed || 5;
        windSpeed = Math.min(55, Math.max(0, windSpeed)) * 3.6; // m/s to km/h, capped at ~200 km/h
        
        // Validate humidity (0-100%)
        let humidity = current.relative_humidity || 80;
        humidity = Math.min(100, Math.max(0, humidity));
        
        // Validate pressure (Arctic typical: 980-1050 hPa)
        let pressure = current.air_pressure_at_sea_level || 1013;
        pressure = Math.min(1100, Math.max(900, pressure));
        
        // Get wind gust if available
        let windGust = current.wind_speed_of_gust || windSpeed / 3.6; // Fallback to wind speed
        windGust = Math.min(80, Math.max(0, windGust)) * 3.6; // Convert to km/h, cap at ~300 km/h
    
    return {
        current: {
                temp_c: Math.round(temperature),
                wind_kph: Math.round(windSpeed),
                wind_gust_kph: Math.round(windGust),
                humidity: Math.round(humidity),
                pressure_mb: Math.round(pressure),
            condition: { 
                text: condition,
                icon: '//cdn.weatherapi.com/weather/64x64/day/116.png'
            },
                wind_dir: getWindDirection(current.wind_from_direction || 0),
                cloud_cover: cloudCover,
                visibility: visibility,
                precipitation_mm: precipitationAmount,
                weather_symbol: weatherSymbol
            },
            location: { 
                localtime: new Date().toISOString(),
                name: 'Ny-Ålesund',
                country: 'Norway'
            }
        };
    } catch (error) {
        console.error('Error processing Yr.no data:', error);
        throw error;
    }
}

// Convert wind direction degrees to compass direction
function getWindDirection(degrees) {
    const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
    return directions[Math.round(degrees / 22.5) % 16];
}


// Update weather display elements
function updateWeatherDisplay(data, dataSource = 'Unknown') {
    const current = data.current;
    
    // Safely update elements (check if they exist first)
    const tempElement = document.getElementById('temperature');
    if (tempElement) tempElement.textContent = `${Math.round(current.temp_c)}°C`;
    
    const windElement = document.getElementById('windSpeed');
    if (windElement) windElement.textContent = `${Math.round(current.wind_kph)} km/h`;
    
    const humidityElement = document.getElementById('humidity');
    if (humidityElement) humidityElement.textContent = `${current.humidity}%`;
    
    const pressureElement = document.getElementById('pressure');
    if (pressureElement) pressureElement.textContent = `${Math.round(current.pressure_mb)} hPa`;
    
    const descElement = document.getElementById('weatherDescription');
    if (descElement) descElement.textContent = current.condition.text;
    
    const windDirElement = document.getElementById('windDirection');
    if (windDirElement) {
        let windText = `Wind: ${current.wind_dir}`;
        if (current.wind_gust_kph && current.wind_gust_kph > current.wind_kph) {
            windText += ` (gusts ${current.wind_gust_kph} km/h)`;
        }
        windDirElement.textContent = windText;
    }
    
    // Update precipitation if available
    const precipElement = document.getElementById('precipitation');
    if (precipElement && current.precipitation_mm !== undefined && current.precipitation_mm > 0) {
        precipElement.textContent = `Precipitation: ${current.precipitation_mm} mm/h`;
        precipElement.style.display = 'block';
    } else if (precipElement) {
        precipElement.style.display = 'none';
    }
    
    // Update weather icon
    const iconElement = document.getElementById('weatherIcon');
    if (iconElement) {
    const condition = current.condition.text.toLowerCase();
    
    if (condition.includes('snow')) {
        iconElement.className = 'fas fa-snowflake text-2xl text-white mr-2';
    } else if (condition.includes('rain')) {
        iconElement.className = 'fas fa-cloud-rain text-2xl text-white mr-2';
    } else if (condition.includes('cloud')) {
        iconElement.className = 'fas fa-cloud text-2xl text-white mr-2';
    } else if (condition.includes('sun') || condition.includes('clear')) {
        iconElement.className = 'fas fa-sun text-2xl text-white mr-2';
    } else if (condition.includes('wind')) {
        iconElement.className = 'fas fa-wind text-2xl text-white mr-2';
    } else if (condition.includes('fog')) {
        iconElement.className = 'fas fa-smog text-2xl text-white mr-2';
    } else {
        iconElement.className = 'fas fa-cloud text-2xl text-white mr-2';
        }
    }
    
    // Update last updated time
    const updateTime = new Date(data.location.localtime).toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        timeZone: 'UTC'
    });
    const lastUpdatedElement = document.getElementById('lastUpdated');
    if (lastUpdatedElement) lastUpdatedElement.textContent = `Updated: ${updateTime} UTC`;
    
    // Update data source
    const dataSourceElement = document.getElementById('dataSource');
    if (dataSourceElement) dataSourceElement.textContent = `Data source: ${dataSource}`;
}

// Update background based on weather conditions
function updateWeatherBackground(data) {
    const condition = data.current.condition.text.toLowerCase();
    
    let weatherType = 'cloudy'; // default
    
    // Determine weather type from condition
    if (condition.includes('snow') || condition.includes('blizzard')) {
        weatherType = 'snow';
    } else if (condition.includes('rain') || condition.includes('drizzle')) {
        weatherType = 'rain';
    } else if (condition.includes('clear') || condition.includes('sunny')) {
        weatherType = 'clear';
    } else if (condition.includes('cloud')) {
        weatherType = condition.includes('overcast') ? 'overcast' : 'cloudy';
    } else if (condition.includes('storm') || condition.includes('thunder')) {
        weatherType = 'storm';
    } else if (condition.includes('fog') || condition.includes('mist')) {
        weatherType = 'fog';
    } else if (condition.includes('wind')) {
        weatherType = 'wind';
    }
    
    // Apply background
    const config = weatherBackgrounds[weatherType] || weatherBackgrounds.cloudy;
    const gradient = config.gradient;
    const heroElement = document.getElementById('weatherHero');
    const overlayElement = document.getElementById('weatherOverlay');
    
    // Update gradient background
    heroElement.style.background = gradient;
    
    // Create background effects based on weather type
    createWeatherBackground(config.backgroundType);
    
    // Add weather particles only for precipitation
    if (config.hasParticles) {
        createWeatherParticles(config.particles, config.particleCount, config.animationType);
    } else {
        // Clear particles for non-precipitation weather
        document.getElementById('weatherParticles').innerHTML = '';
    }
}

// Create CSS-based weather background effects
function createWeatherBackground(backgroundType) {
    const overlayElement = document.getElementById('weatherOverlay');
    overlayElement.innerHTML = '';
    overlayElement.className = 'absolute inset-0 transition-all duration-1000';
    
    switch (backgroundType) {
        case 'cloudy':
        case 'overcast':
            // Create CSS cloud shapes
            overlayElement.innerHTML = `
                <div class="css-cloud cloud-1"></div>
                <div class="css-cloud cloud-2"></div>
                <div class="css-cloud cloud-3"></div>
                <div class="css-cloud cloud-4"></div>
            `;
            break;
            
        case 'fog':
            // Create fog layers
            overlayElement.innerHTML = `
                <div class="fog-layer fog-1"></div>
                <div class="fog-layer fog-2"></div>
                <div class="fog-layer fog-3"></div>
            `;
            break;
            
        case 'storm':
            // Create storm clouds with subtle lightning effect
            overlayElement.innerHTML = `
                <div class="storm-cloud storm-1"></div>
                <div class="storm-cloud storm-2"></div>
                <div class="lightning-flash"></div>
            `;
            break;
            
        case 'wind':
            // Create wind streak effects
            overlayElement.innerHTML = `
                <div class="wind-streak wind-1"></div>
                <div class="wind-streak wind-2"></div>
                <div class="wind-streak wind-3"></div>
            `;
            break;
            
        default:
            // Clear background for clear/sunny/rain/snow
            overlayElement.innerHTML = '';
    }
}

// Create animated weather particles
function createWeatherParticles(particle, count, animationType) {
    const container = document.getElementById('weatherParticles');
    container.innerHTML = ''; // Clear existing particles
    
    for (let i = 0; i < count; i++) {
        const particleElement = document.createElement('div');
        particleElement.textContent = particle;
        particleElement.className = 'weather-particle absolute';
        particleElement.style.left = Math.random() * 100 + '%';
        particleElement.style.animationDelay = Math.random() * 10 + 's';
        particleElement.style.fontSize = '1.2rem'; // Set font size directly instead of using Tailwind class
        
        // Set specific animation based on animation type
        switch (animationType) {
            case 'fall':
                // Only for precipitation (rain, snow)
                if (particle === '❄️') {
                    particleElement.style.animationName = Math.random() > 0.5 ? 'snowFall' : 'snowDrift';
                    particleElement.style.animationDuration = (Math.random() * 3 + 6) + 's';
                    // Force white snowflakes with multiple overrides
                    particleElement.style.color = '#ffffff';
                    particleElement.style.fontSize = '1.2rem';
                    particleElement.style.background = 'transparent';
                    particleElement.style.textShadow = 'none';
                    particleElement.style.filter = 'none';
                    particleElement.style.webkitTextFillColor = '#ffffff';
                    particleElement.style.webkitBackgroundClip = 'initial';
                    particleElement.style.backgroundClip = 'initial';
                    // Ensure the snowflake character itself is white
                    particleElement.setAttribute('style', particleElement.getAttribute('style') + '; color: #ffffff !important;');
                } else if (particle === '💧') {
                    particleElement.style.animationName = 'rainFall';
                    particleElement.style.animationDuration = (Math.random() * 1 + 2) + 's';
                }
                break;
                
            case 'drift':
                // For clouds - horizontal floating movement
                particleElement.style.animationName = 'cloudDrift';
                particleElement.style.animationDuration = (Math.random() * 10 + 15) + 's';
                particleElement.style.top = (Math.random() * 30 + 10) + '%';
                break;
                
            case 'glow':
                // For sun - gentle pulsing in place
                particleElement.style.animationName = 'sunGlow';
                particleElement.style.animationDuration = (Math.random() * 2 + 3) + 's';
                particleElement.style.top = (Math.random() * 20 + 15) + '%';
                break;
                
            case 'sun':
                // For realistic sun - single sun positioned in upper sky
                particleElement.style.animationName = 'sunGlow';
                particleElement.style.animationDuration = '4s';
                particleElement.style.top = '15%'; // Fixed position in upper sky
                particleElement.style.left = '75%'; // Fixed position (upper right)
                particleElement.style.fontSize = '3rem'; // Larger sun
                particleElement.style.textShadow = '0 0 20px rgba(255, 215, 0, 0.8)'; // Sun glow effect
                break;
                
            case 'float':
                // For fog - slow vertical floating
                particleElement.style.animationName = 'fogFloat';
                particleElement.style.animationDuration = (Math.random() * 8 + 12) + 's';
                particleElement.style.top = (Math.random() * 40 + 30) + '%';
                break;
                
            case 'blow':
                // For wind - horizontal movement
                particleElement.style.animationName = 'windBlow';
                particleElement.style.animationDuration = (Math.random() * 3 + 2) + 's';
                particleElement.style.top = (Math.random() * 30 + 20) + '%';
                break;
                
            case 'flash':
                // For lightning - occasional flashing
                particleElement.style.animationName = 'lightningFlash';
                particleElement.style.animationDuration = (Math.random() * 5 + 8) + 's';
                particleElement.style.top = (Math.random() * 40 + 10) + '%';
                break;
                
            default:
                // Default gentle floating
                particleElement.style.animationName = 'weatherFloat';
                particleElement.style.animationDuration = (Math.random() * 5 + 5) + 's';
        }
        
        container.appendChild(particleElement);
    }
}

// Initialize weather when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Fetch weather data immediately
    fetchWeatherData();
    
    // Update weather every 10 minutes
    setInterval(fetchWeatherData, 10 * 60 * 1000);
    
    // Initialize map
    const map = L.map('arcticMap').setView([78.9, 11.9], 6);
    
    // Base layers
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '© Esri'
    });
    
    // Custom icons using Font Awesome
    function createCustomIcon(iconClass, color, bgColor) {
        return L.divIcon({
            html: `<div style="background-color: ${bgColor}; border: 2px solid ${color}; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                     <i class="${iconClass}" style="color: ${color}; font-size: 14px;"></i>
                   </div>`,
            className: 'custom-div-icon',
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
        });
    }
    
    // Enhanced research locations
    const locations = [
        // CTD Measurements
        { lat: 78.9, lng: 11.9, type: 'ctd', name: 'Ny-Ålesund CTD Station', 
          description: 'Deep water conductivity, temperature, and depth measurements', 
          depth: '200m', status: 'Active', samples: 45 },
        { lat: 79.1, lng: 12.2, type: 'ctd', name: 'Kongsfjorden CTD', 
          description: 'Fjord water column analysis and monitoring', 
          depth: '150m', status: 'Active', samples: 32 },
        { lat: 78.7, lng: 11.5, type: 'ctd', name: 'Barentsburg CTD', 
          description: 'Coastal water mass characterization', 
          depth: '100m', status: 'Completed', samples: 28 },
        
        // Ice Sampling
        { lat: 79.2, lng: 10.8, type: 'ice', name: 'Sea Ice Station Alpha', 
          description: 'Multi-year ice core drilling and analysis', 
          thickness: '2.5m', status: 'Active', samples: 18 },
        { lat: 79.0, lng: 13.1, type: 'ice', name: 'Ice Edge Station', 
          description: 'First-year ice formation studies', 
          thickness: '1.2m', status: 'Planned', samples: 0 },
        { lat: 78.8, lng: 10.2, type: 'ice', name: 'Fast Ice Station', 
          description: 'Landfast ice dynamics research', 
          thickness: '3.1m', status: 'Active', samples: 22 },
        
        // Sediment Sampling
        { lat: 78.6, lng: 11.8, type: 'sediment', name: 'Seafloor Station 1', 
          description: 'Marine sediment coring for paleoclimate', 
          depth: '300m', status: 'Completed', samples: 15 },
        { lat: 79.3, lng: 12.5, type: 'sediment', name: 'Deep Basin Core', 
          description: 'Long-term climate record extraction', 
          depth: '500m', status: 'Active', samples: 8 },
        
        // Water Sampling
        { lat: 78.95, lng: 11.7, type: 'water', name: 'Surface Water Station', 
          description: 'Microplastic and pollutant analysis', 
          depth: '5m', status: 'Active', samples: 67 },
        { lat: 79.15, lng: 11.3, type: 'water', name: 'Meltwater Station', 
          description: 'Glacier runoff chemistry monitoring', 
          depth: '2m', status: 'Seasonal', samples: 34 },
        { lat: 78.75, lng: 12.8, type: 'water', name: 'Deep Water Station', 
          description: 'Nutrient cycling and biogeochemistry', 
          depth: '400m', status: 'Active', samples: 41 },
        
        // Aerosol Sampling
        { lat: 78.92, lng: 11.93, type: 'aerosol', name: 'Himadri Station', 
          description: 'Continuous atmospheric aerosol monitoring', 
          elevation: '55m', status: 'Continuous', samples: 156 },
        { lat: 79.05, lng: 12.1, type: 'aerosol', name: 'Mountain Station', 
          description: 'High altitude atmospheric composition', 
          elevation: '400m', status: 'Active', samples: 89 }
    ];
    
    // Icon configurations
    const iconConfig = {
        ctd: { icon: 'fas fa-water', color: '#1E40AF', bgColor: '#DBEAFE' },
        ice: { icon: 'fas fa-snowflake', color: '#0EA5E9', bgColor: '#F0F9FF' },
        sediment: { icon: 'fas fa-mountain', color: '#D97706', bgColor: '#FEF3C7' },
        water: { icon: 'fas fa-tint', color: '#059669', bgColor: '#D1FAE5' },
        aerosol: { icon: 'fas fa-wind', color: '#7C3AED', bgColor: '#EDE9FE' }
    };
    
    // Status colors
    const statusColors = {
        'Active': '#10B981',
        'Completed': '#6B7280',
        'Planned': '#F59E0B',
        'Seasonal': '#8B5CF6',
        'Continuous': '#EF4444'
    };
    
    // Add markers to map
    const markers = [];
    locations.forEach(loc => {
        const config = iconConfig[loc.type];
        const marker = L.marker([loc.lat, loc.lng], {
            icon: createCustomIcon(config.icon, config.color, config.bgColor)
        }).bindPopup(`
            <div class="p-4 min-w-72">
                <div class="flex items-center mb-3">
                    <i class="${config.icon}" style="color: ${config.color}; font-size: 18px; margin-right: 8px;"></i>
                    <h3 class="font-bold text-lg text-deep-arctic">${loc.name}</h3>
                </div>
                <p class="text-sm text-gray-600 mb-3">${loc.description}</p>
                <div class="grid grid-cols-2 gap-3 text-xs">
                    <div class="bg-gray-50 p-2 rounded">
                        <strong>Type:</strong><br>
                        <span style="color: ${config.color}">${loc.type.toUpperCase()}</span>
                    </div>
                    <div class="bg-gray-50 p-2 rounded">
                        <strong>Status:</strong><br>
                        <span style="color: ${statusColors[loc.status]}">${loc.status}</span>
                    </div>
                    ${loc.depth ? `<div class="bg-gray-50 p-2 rounded"><strong>Depth:</strong><br>${loc.depth}</div>` : ''}
                    ${loc.thickness ? `<div class="bg-gray-50 p-2 rounded"><strong>Ice Thickness:</strong><br>${loc.thickness}</div>` : ''}
                    ${loc.elevation ? `<div class="bg-gray-50 p-2 rounded"><strong>Elevation:</strong><br>${loc.elevation}</div>` : ''}
                    <div class="bg-gray-50 p-2 rounded">
                        <strong>Samples:</strong><br>${loc.samples}
                    </div>
                    <div class="bg-gray-50 p-2 rounded col-span-2">
                        <strong>Coordinates:</strong><br>${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}
                    </div>
                </div>
            </div>
        `).addTo(map);
        markers.push(marker);
    });
    
    // Control functionality
    let layersVisible = true;
    let currentLayer = osmLayer;
    
    document.getElementById('toggleLayers').addEventListener('click', function() {
        if (layersVisible) {
            markers.forEach(marker => map.removeLayer(marker));
            this.textContent = 'Show Research Stations';
            document.getElementById('stationCount').textContent = '0';
        } else {
            markers.forEach(marker => map.addLayer(marker));
            this.textContent = 'Hide Research Stations';
            document.getElementById('stationCount').textContent = locations.length;
        }
        layersVisible = !layersVisible;
    });
    
    document.getElementById('satelliteView').addEventListener('click', function() {
        if (currentLayer === osmLayer) {
            map.removeLayer(osmLayer);
            map.addLayer(satelliteLayer);
            currentLayer = satelliteLayer;
            this.textContent = 'Street Map View';
        } else {
            map.removeLayer(satelliteLayer);
            map.addLayer(osmLayer);
            currentLayer = osmLayer;
            this.textContent = 'Satellite View';
        }
    });
    
    document.getElementById('resetView').addEventListener('click', function() {
        map.setView([78.9, 11.9], 6);
        document.getElementById('mapStatus').textContent = 'Map view reset';
        setTimeout(() => {
            document.getElementById('mapStatus').textContent = 'Map loaded successfully';
        }, 2000);
    });
    
    // Add scale control
    L.control.scale({
        position: 'bottomright',
        metric: true,
        imperial: false
    }).addTo(map);
    
    // Map event listeners
    map.on('zoomend', function() {
        document.getElementById('mapStatus').textContent = `Zoom level: ${map.getZoom()}`;
        setTimeout(() => {
            document.getElementById('mapStatus').textContent = 'Map loaded successfully';
        }, 2000);
    });
});
</script>

<style>
/* Enhanced Custom Styles */
#arcticMap {
    background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
}

.leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    max-width: 350px;
}

.leaflet-popup-content {
    margin: 0;
    line-height: 1.4;
}

.custom-div-icon {
    background: transparent !important;
    border: none !important;
}

/* Weather Background Styles */
.weather-background {
    background: linear-gradient(135deg, #708090 0%, #778899 50%, #87CEEB 100%);
    transition: background 1s ease-in-out;
}

/* Ensure text visibility on all weather backgrounds */
#weatherHero .text-white {
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7), 1px 1px 2px rgba(0, 0, 0, 0.5);
    color: #ffffff !important;
}

#weatherHero .text-white\/90 {
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6), 1px 1px 2px rgba(0, 0, 0, 0.4);
    color: rgba(255, 255, 255, 0.9) !important;
}

#weatherHero .text-white\/80 {
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6), 1px 1px 2px rgba(0, 0, 0, 0.4);
    color: rgba(255, 255, 255, 0.8) !important;
}

#weatherHero .text-white\/70 {
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6), 1px 1px 2px rgba(0, 0, 0, 0.4);
    color: rgba(255, 255, 255, 0.7) !important;
}

/* Weather Particle Animations */
.weather-particle {
    animation: weatherFloat 8s ease-in-out infinite;
    opacity: 0.9;
    pointer-events: none;
    top: -50px;
    color: #ffffff !important;
    background: transparent !important;
    text-shadow: none !important;
    filter: none !important;
    -webkit-text-fill-color: #ffffff !important;
    -webkit-background-clip: initial !important;
    background-clip: initial !important;
}

@keyframes weatherFloat {
    0% {
        transform: translateY(-50px) translateX(0px) rotate(0deg);
        opacity: 0;
    }
    10% {
        opacity: 0.7;
    }
    90% {
        opacity: 0.7;
    }
    100% {
        transform: translateY(calc(100vh + 50px)) translateX(20px) rotate(360deg);
        opacity: 0;
    }
}

/* Snow specific animation */
.weather-particle:nth-child(odd) {
    animation: snowFall 6s linear infinite;
}

.weather-particle:nth-child(even) {
    animation: snowDrift 8s linear infinite;
}

/* Specific snowflake styling - Force white color */
.weather-particle:contains("❄️"),
.weather-particle[style*="❄️"],
#weatherParticles .weather-particle {
    color: #ffffff !important;
    font-size: 1.2rem !important;
    background: transparent !important;
    text-shadow: none !important;
    filter: none !important;
    -webkit-text-fill-color: #ffffff !important;
    -webkit-background-clip: initial !important;
    background-clip: initial !important;
}

/* Snowflake emoji specific override */
.weather-particle {
    font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif !important;
}

/* Global snowflake color override - target all possible selectors */
[class*="weather-particle"], 
.weather-particle, 
#weatherParticles div, 
#weatherParticles > *, 
*[style*="❄"]:not(.ignore-white) {
    color: white !important;
    -webkit-text-fill-color: white !important;
}

/* Force emoji snowflakes to display as white */
.weather-particle::before,
.weather-particle::after {
    color: white !important;
}

/* Override any Tailwind text color classes */
.text-2xl.weather-particle {
    color: white !important;
}

@keyframes snowFall {
    0% {
        transform: translateY(-50px) translateX(0px);
        opacity: 0;
    }
    10% {
        opacity: 0.8;
    }
    90% {
        opacity: 0.8;
    }
    100% {
        transform: translateY(calc(100vh + 50px)) translateX(0px);
        opacity: 0;
    }
}

@keyframes snowDrift {
    0% {
        transform: translateY(-50px) translateX(0px);
        opacity: 0;
    }
    10% {
        opacity: 0.6;
    }
    25% {
        transform: translateY(25vh) translateX(10px);
    }
    50% {
        transform: translateY(50vh) translateX(-5px);
    }
    75% {
        transform: translateY(75vh) translateX(15px);
    }
    90% {
        opacity: 0.6;
    }
    100% {
        transform: translateY(calc(100vh + 50px)) translateX(0px);
        opacity: 0;
    }
}

/* Rain animation */
@keyframes rainFall {
    0% {
        transform: translateY(-50px) translateX(0px) rotate(15deg);
        opacity: 0;
    }
    10% {
        opacity: 0.8;
    }
    90% {
        opacity: 0.8;
    }
    100% {
        transform: translateY(calc(100vh + 50px)) translateX(-10px) rotate(15deg);
        opacity: 0;
    }
}

/* Cloud drifting animation - horizontal movement */
@keyframes cloudDrift {
    0% {
        transform: translateX(-100px);
        opacity: 0.6;
    }
    50% {
        opacity: 0.8;
    }
    100% {
        transform: translateX(calc(100vw + 100px));
        opacity: 0.6;
    }
}

/* Sun glowing animation - gentle pulsing */
@keyframes sunGlow {
    0%, 100% {
        transform: scale(1);
        opacity: 0.95;
        filter: brightness(1) drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));
    }
    50% {
        transform: scale(1.05);
        opacity: 1;
        filter: brightness(1.1) drop-shadow(0 0 25px rgba(255, 215, 0, 0.8));
    }
}

/* Fog floating animation - gentle vertical movement */
@keyframes fogFloat {
    0%, 100% {
        transform: translateY(0px) translateX(0px);
        opacity: 0.5;
    }
    25% {
        transform: translateY(-10px) translateX(5px);
        opacity: 0.7;
    }
    75% {
        transform: translateY(10px) translateX(-5px);
        opacity: 0.7;
    }
}

/* Wind blowing animation - fast horizontal movement */
@keyframes windBlow {
    0% {
        transform: translateX(-50px);
        opacity: 0.4;
    }
    50% {
        opacity: 0.8;
    }
    100% {
        transform: translateX(calc(100vw + 50px));
        opacity: 0.4;
    }
}

/* Lightning flashing animation - occasional bright flashes */
@keyframes lightningFlash {
    0%, 85%, 100% {
        opacity: 0;
    }
    87%, 89%, 91% {
        opacity: 1;
        filter: brightness(2);
    }
    88%, 90% {
        opacity: 0.3;
    }
}

/* CSS Cloud Shapes */
.css-cloud {
    position: absolute;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 100px;
    opacity: 0.6;
}

.css-cloud:before,
.css-cloud:after {
    content: '';
    position: absolute;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 100px;
}

.css-cloud:before {
    width: 50px;
    height: 50px;
    top: -25px;
    left: 10px;
    transform: scale(1.3);
}

.css-cloud:after {
    width: 60px;
    height: 20px;
    top: -10px;
    right: 10px;
}

/* Individual cloud positioning and animations */
.cloud-1 {
    width: 100px;
    height: 40px;
    top: 15%;
    left: -100px;
    animation: cloudDriftSlow 20s linear infinite;
}

.cloud-2 {
    width: 80px;
    height: 30px;
    top: 25%;
    left: -80px;
    animation: cloudDriftSlow 25s linear infinite;
    animation-delay: -5s;
}

.cloud-3 {
    width: 120px;
    height: 45px;
    top: 35%;
    left: -120px;
    animation: cloudDriftSlow 30s linear infinite;
    animation-delay: -10s;
}

.cloud-4 {
    width: 90px;
    height: 35px;
    top: 45%;
    left: -90px;
    animation: cloudDriftSlow 22s linear infinite;
    animation-delay: -15s;
}

@keyframes cloudDriftSlow {
    0% {
        transform: translateX(0);
    }
    100% {
        transform: translateX(calc(100vw + 200px));
    }
}

/* Fog Layers */
.fog-layer {
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, 
        rgba(255, 255, 255, 0) 0%, 
        rgba(255, 255, 255, 0.3) 50%, 
        rgba(255, 255, 255, 0) 100%);
    animation: fogDrift 15s ease-in-out infinite;
}

.fog-1 {
    bottom: 20%;
    animation-delay: 0s;
}

.fog-2 {
    bottom: 30%;
    animation-delay: -5s;
    opacity: 0.7;
}

.fog-3 {
    bottom: 40%;
    animation-delay: -10s;
    opacity: 0.5;
}

@keyframes fogDrift {
    0%, 100% {
        transform: translateX(-10px);
        opacity: 0.3;
    }
    50% {
        transform: translateX(10px);
        opacity: 0.6;
    }
}

/* Storm Clouds */
.storm-cloud {
    position: absolute;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 100px;
    opacity: 0.7;
}

.storm-cloud:before,
.storm-cloud:after {
    content: '';
    position: absolute;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 100px;
}

.storm-1 {
    width: 150px;
    height: 60px;
    top: 10%;
    left: 20%;
    animation: stormCloudMove 8s ease-in-out infinite;
}

.storm-2 {
    width: 120px;
    height: 50px;
    top: 20%;
    right: 25%;
    animation: stormCloudMove 10s ease-in-out infinite;
    animation-delay: -3s;
}

.lightning-flash {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    animation: lightningEffect 12s ease-in-out infinite;
}

@keyframes stormCloudMove {
    0%, 100% {
        transform: translateX(0px);
    }
    50% {
        transform: translateX(20px);
    }
}

@keyframes lightningEffect {
    0%, 90%, 100% {
        opacity: 0;
    }
    91%, 93% {
        opacity: 0.3;
        background: rgba(255, 255, 255, 0.2);
    }
    92% {
        opacity: 0;
    }
}

/* Wind Streaks */
.wind-streak {
    position: absolute;
    height: 2px;
    background: linear-gradient(to right, 
        rgba(255, 255, 255, 0) 0%, 
        rgba(255, 255, 255, 0.5) 50%, 
        rgba(255, 255, 255, 0) 100%);
    animation: windMove 3s linear infinite;
}

.wind-1 {
    top: 25%;
    width: 150px;
    animation-delay: 0s;
}

.wind-2 {
    top: 35%;
    width: 200px;
    animation-delay: -1s;
}

.wind-3 {
    top: 45%;
    width: 100px;
    animation-delay: -2s;
}

@keyframes windMove {
    0% {
        left: -200px;
        opacity: 0;
    }
    20% {
        opacity: 1;
    }
    80% {
        opacity: 1;
    }
    100% {
        left: 100%;
        opacity: 0;
    }
}

/* Weather card enhancements */
.weather-info-card {
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    background: rgba(0, 0, 0, 0.15) !important;
}

.weather-info-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
}

/* Enhanced Card Styles */
.arctic-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    transition: all 0.3s ease;
}

.arctic-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 16px 48px rgba(31, 38, 135, 0.2);
}

/* Gradient Text */
.gradient-text {
    background: linear-gradient(45deg, #1E40AF, #06B6D4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

/* Status Indicator Animation */
@keyframes pulse-dot {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.7;
        transform: scale(1.1);
    }
}

.animate-pulse-dot {
    animation: pulse-dot 2s infinite;
}

/* Responsive adjustments */
@media (max-width: 1024px) {
    #arcticMap {
        min-height: 500px !important;
        flex: 1 !important;
    }
    
    .snowflake {
        display: none;
    }
    
    .grid.grid-cols-1.lg\\:grid-cols-3 {
        min-height: 700px !important;
    }
}

@media (max-width: 768px) {
    #arcticMap {
        min-height: 400px !important;
        flex: 1 !important;
    }
    
    .grid-cols-2 {
        grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
    }
    
    .grid.grid-cols-1.lg\\:grid-cols-3 {
        min-height: auto !important;
    }
}

/* Button Animations */
.btn-shimmer {
    position: relative;
    overflow: hidden;
}

.btn-shimmer::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-shimmer:hover::before {
    left: 100%;
}
</style>

{% endblock %} 
