{% extends "base.html" %}

{% block title %}Combine Shipments - COMPASS{% endblock %}

{% block content %}
<style>
    /* Base styles from export form */
    .form-section {
        transition: all 0.3s ease;
    }

    .input-field {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: 1px solid var(--arctic-blue);
        background-color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
    }

    .input-field:focus {
        outline: none;
        border: 2px solid var(--deep-arctic);
        box-shadow: 0 0 0 2px rgba(30, 63, 102, 0.1);
    }

    .input-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.25rem;
    }

    .invoice-preview {
        background: linear-gradient(145deg, #FFE0B2, #FFF3E0);
        border-radius: 0.75rem;
        padding: 1.5rem;
        border: 2px solid #FF9800;
        position: sticky;
        top: 1rem;
    }

    .readonly-field {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 1rem;
        border-radius: 0.5rem;
        color: #475569;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    .section-title {
        color: var(--deep-arctic);
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(30, 63, 102, 0.1);
    }

    .arctic-card {
        transition: all 0.3s ease;
    }

    .arctic-card:hover {
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }

    .attn-field {
        background: linear-gradient(145deg, #E8F5E8, #F0FFF0);
        border: 2px solid #4CAF50;
    }

    .combined-badge {
        background: linear-gradient(145deg, #FFE0B2, #FFF3E0);
        border: 2px solid #FF9800;
        color: #E65100;
    }
</style>

<div class="min-h-[80vh] flex items-start justify-center pt-10">
    <div class="w-full max-w-6xl">
        <!-- Progress Indicator -->
        <div class="arctic-card p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="text-xl mr-2">üîÑ</span>
                    <h2 class="text-lg font-semibold text-deep-arctic">Combine Shipments</h2>
                </div>
                <div class="text-sm text-gray-600">
                    Final Review & Generate
                </div>
            </div>
            <div class="mt-3 h-2 bg-gray-200 rounded-full">
                <div class="h-full w-full bg-orange-500 rounded-full"></div>
            </div>
        </div>

        <!-- Combined Shipments Summary -->
        <div class="arctic-card p-4 mb-6 combined-badge">
            <h3 class="text-lg font-semibold mb-2">Combining {{ shipments|length }} Shipments</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                {% for shipment in shipments %}
                <div class="bg-white p-2 rounded">
                    <div class="font-medium">{{ shipment.invoice_number }}</div>
                    <div class="text-gray-600">{{ shipment.requester_name }}</div>
                    <div class="text-gray-500">{{ shipment.total_packages }} packages</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Invoice Number Preview -->
        <div class="arctic-card p-4 mb-6 invoice-preview">
            <h3 class="text-lg font-semibold text-orange-800 mb-2">üéØ Combined Invoice Number</h3>
            <div class="text-xl font-mono tracking-wide text-orange-900">
                {{ combined_invoice }}
            </div>
            <p class="text-sm text-orange-700 mt-2">This unique combined shipment number will be used in documentation</p>
        </div>

        <!-- Main Form -->
        <div class="arctic-card p-8">
            <h1 class="text-2xl font-bold text-deep-arctic mb-6">
                {% if edit_mode %}Edit Combined Shipment{% else %}Combined Shipment Details{% endif %}
            </h1>
            
            <form method="POST" action="{% if edit_mode %}{{ url_for('main.update_shipment', shipment_id=shipment.id) }}{% else %}{{ url_for('main.admin_finalize_combine') }}{% endif %}" class="space-y-8">
                <!-- Hidden fields for tracking -->
                <input type="hidden" name="combined_number" value="{{ combined_number }}">
                <input type="hidden" name="combined_invoice" value="{{ combined_invoice }}">
                <input type="hidden" name="total_packages" value="{{ total_packages }}">
                <input type="hidden" name="shipment_type" value="{{ first_shipment.shipment_type }}">

                <!-- Combined Shipment Details -->
                <div class="space-y-4">
                    <h3 class="section-title">Combined Shipment Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="input-label">Requester Name</label>
                            <input type="text" 
                                   name="requester_name" 
                                   value="Combined Shipment"
                                   class="input-field"
                                   placeholder="Enter requester name"
                                   required>
                        </div>
                        <div>
                            <label class="input-label">Total Packages</label>
                            <div class="readonly-field">{{ total_packages }} packages</div>
                        </div>
                        <div>
                            <label class="input-label">Expedition Year</label>
                            <input type="text" 
                                   name="expedition_year" 
                                   value="{{ first_shipment.expedition_year }}"
                                   class="input-field"
                                   placeholder="Enter expedition year"
                                   required>
                        </div>
                        <div>
                            <label class="input-label">Shipment Type</label>
                            <div class="readonly-field">{{ first_shipment.shipment_type.title() }}</div>
                        </div>
                        <div>
                            <label class="input-label">Destination Country</label>
                            <input type="text" 
                                   name="destination_country" 
                                   value="{{ first_shipment.destination_country }}"
                                   class="input-field"
                                   placeholder="Enter destination country"
                                   required>
                        </div>
                        <div>
                            <label class="input-label">Batch Number</label>
                            <input type="text" 
                                   name="batch_number" 
                                   value="{{ first_shipment.batch_number }}"
                                   class="input-field"
                                   placeholder="Enter batch number"
                                   required>
                        </div>
                    </div>
                </div>

                <!-- Package & Item Details -->
                <div class="space-y-6">
                    <h3 class="section-title">üì¶ Package & Item Details</h3>
                    
                    {% for package in combined_packages %}
                    <div class="arctic-card p-6 border-2 border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-deep-arctic">
                                üì¶ Package {{ package.package_number }} ({{ package.type }})
                            </h4>
                            <span class="bg-deep-arctic text-white px-3 py-1 rounded-full text-sm">
                                {{ package.length }} √ó {{ package.width }} √ó {{ package.height }} cm
                            </span>
                        </div>
                        
                        <!-- Package hidden fields -->
                        <input type="hidden" name="package_{{ package.package_number }}_type" value="{{ package.type }}">
                        <input type="hidden" name="package_{{ package.package_number }}_length" value="{{ package.length }}">
                        <input type="hidden" name="package_{{ package.package_number }}_width" value="{{ package.width }}">
                        <input type="hidden" name="package_{{ package.package_number }}_height" value="{{ package.height }}">
                        <input type="hidden" name="package_{{ package.package_number }}_items_count" value="{{ package.items_count }}">

                        <!-- Items in this package -->
                        <div class="space-y-4">
                            {% if package.item_list %}
                                {% for item in package.item_list %}
                                <div class="arctic-card p-4 border border-gray-300">
                                    <h5 class="font-semibold text-deep-arctic mb-4">
                                        Item {{ loop.index }} Details
                                    </h5>
                                    <div class="space-y-4">
                                        <!-- SPECIAL: Attn Field for Combined Shipments -->
                                        <div>
                                            <label class="input-label">‚≠ê Attn: (Requester Name) - REQUIRED</label>
                                            <input type="text" 
                                                   name="package_{{ package.package_number }}_item_{{ loop.index }}_attn" 
                                                   value="{{ item.requester }}"
                                                   class="input-field attn-field"
                                                   placeholder="Enter requester name for this item"
                                                   required>
                                            <p class="text-sm text-green-700 mt-1">This name will appear in the document as "Box-{{ package.package_number }} ({{ package.type }}) [Name]"</p>
                                        </div>

                                        <!-- Item Details Grid -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="md:col-span-2">
                                                <label class="input-label">Description of Goods</label>
                                                <input type="text" 
                                                       name="package_{{ package.package_number }}_item_{{ loop.index }}_description" 
                                                       value="{{ item.description }}"
                                                       class="input-field"
                                                       placeholder="Enter description of goods"
                                                       required>
                                            </div>
                                            <div>
                                                <label class="input-label">HSN Code</label>
                                                <input type="text" 
                                                       name="package_{{ package.package_number }}_item_{{ loop.index }}_hsn_code" 
                                                       value="{{ item.hsn_code }}"
                                                       class="input-field"
                                                       placeholder="Enter HSN Code"
                                                       required>
                                            </div>
                                            <div>
                                                <label class="input-label">Quantity</label>
                                                <input type="number" 
                                                       name="package_{{ package.package_number }}_item_{{ loop.index }}_quantity" 
                                                       value="{{ item.quantity }}"
                                                       class="input-field quantity-input"
                                                       min="1"
                                                       required>
                                            </div>
                                            <div>
                                                <label class="input-label">Unit Value (USD)</label>
                                                <input type="number" 
                                                       name="package_{{ package.package_number }}_item_{{ loop.index }}_unit_value" 
                                                       value="{{ item.unit_value }}"
                                                       class="input-field unit-value-input"
                                                       step="0.01"
                                                       min="0"
                                                       required>
                                            </div>
                                            <div>
                                                <label class="input-label">Net Weight (kg)</label>
                                                <input type="number" 
                                                       name="package_{{ package.package_number }}_item_{{ loop.index }}_net_weight" 
                                                       value="{{ item.net_weight }}"
                                                       class="input-field"
                                                       step="0.01"
                                                       min="0"
                                                       required>
                                            </div>
                                            <div>
                                                <label class="input-label">Total Value</label>
                                                <div class="readonly-field bg-blue-50 border-blue-200">
                                                    $<span class="total-value">{{ "%.2f"|format(item.unit_value|float * item.quantity|int) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Hidden fields for this item (existing data) -->
                                    <input type="hidden" name="package_{{ package.package_number }}_item_{{ loop.index }}_origin" value="India">
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Combined Shipment Summary -->
                <div class="arctic-card p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200">
                    <h4 class="text-xl font-semibold text-deep-arctic mb-4">üìã Combined Shipment Summary</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div class="text-center">
                            <p class="text-gray-600">Total Packages</p>
                            <p class="text-3xl font-bold text-deep-arctic">{{ total_packages }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600">Total Items</p>
                            <p class="text-3xl font-bold text-deep-arctic">{{ total_items }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600">Original Shipments</p>
                            <p class="text-3xl font-bold text-orange-600">{{ shipments|length }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-gray-600">Combined Type</p>
                            <p class="text-lg font-bold text-deep-arctic">{{ first_shipment.shipment_type.title() }}</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between pt-6" 
                     data-shipments-count="{{ (shipments|length) if shipments else 0 }}"
                     data-total-packages="{{ total_packages or 0 }}"
                     data-combined-invoice="{{ combined_invoice or 'Unknown' }}">
                    <a href="{{ url_for('main.dashboard') }}" 
                       class="arctic-button bg-gray-500 hover:bg-gray-600 px-8 py-3 text-white font-semibold rounded-lg transition-colors">
                        ‚Üê Cancel & Return to Dashboard
                    </a>
                    <button type="submit" 
                            class="arctic-button bg-orange-600 hover:bg-orange-700 px-8 py-3 text-white font-semibold rounded-lg transition-colors">
                        {% if edit_mode %}üíæ Update Combined Shipment{% else %}üöÄ Generate Combined Document{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validation for Attn fields
    const form = document.querySelector('form');
    const attnFields = document.querySelectorAll('input[name*="_attn"]');
    
    // Real-time validation styling for attn fields
    attnFields.forEach(field => {
        field.addEventListener('input', function() {
            if (this.value.trim()) {
                this.style.borderColor = '#4CAF50';
                this.style.backgroundColor = '#F0FFF0';
            } else {
                this.style.borderColor = '#FF5722';
                this.style.backgroundColor = '#FFEBEE';
            }
        });
        
        // Initial validation
        if (field.value.trim()) {
            field.style.borderColor = '#4CAF50';
            field.style.backgroundColor = '#F0FFF0';
        }
    });
    
    // Dynamic total value calculation
    function updateTotalValue(quantityInput, unitValueInput, totalValueSpan) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitValue = parseFloat(unitValueInput.value) || 0;
        const total = quantity * unitValue;
        totalValueSpan.textContent = total.toFixed(2);
    }
    
    // Set up dynamic calculation for all items
    const quantityInputs = document.querySelectorAll('.quantity-input');
    const unitValueInputs = document.querySelectorAll('.unit-value-input');
    
    quantityInputs.forEach((quantityInput, index) => {
        const unitValueInput = unitValueInputs[index];
        const totalValueSpan = quantityInput.closest('.grid').querySelector('.total-value');
        
        if (unitValueInput && totalValueSpan) {
            // Update on quantity change
            quantityInput.addEventListener('input', function() {
                updateTotalValue(quantityInput, unitValueInput, totalValueSpan);
            });
            
            // Update on unit value change
            unitValueInput.addEventListener('input', function() {
                updateTotalValue(quantityInput, unitValueInput, totalValueSpan);
            });
        }
    });
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        let allValid = true;
        const emptyFields = [];
        
        // Check attn fields
        attnFields.forEach((field, index) => {
            if (!field.value.trim()) {
                allValid = false;
                emptyFields.push(`Item ${index + 1} Attn`);
                field.style.borderColor = '#FF5722';
                field.style.backgroundColor = '#FFEBEE';
                field.focus();
            }
        });
        
        // Check required fields
        const requiredFields = document.querySelectorAll('input[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                allValid = false;
                field.style.borderColor = '#FF5722';
                field.style.backgroundColor = '#FFEBEE';
            } else {
                field.style.borderColor = '#4CAF50';
                field.style.backgroundColor = '#F0FFF0';
            }
        });
        
        if (!allValid) {
            e.preventDefault();
            alert(`‚ùå Please fill in all required fields before generating the combined document.\n\nMissing fields: ${emptyFields.join(', ')}`);
            return;
        }
        
        // Get data from data attributes
        const buttonContainer = document.querySelector('[data-shipments-count]');
        const originalShipments = buttonContainer ? buttonContainer.dataset.shipmentsCount : '0';
        const totalPackages = buttonContainer ? buttonContainer.dataset.totalPackages : '0';
        const combinedInvoice = buttonContainer ? buttonContainer.dataset.combinedInvoice : 'Unknown';
        
        if (!confirm(`üîÑ Generate Combined Shipment Document?\n\nüìä Summary:\n‚Ä¢ Original Shipments: ${originalShipments}\n‚Ä¢ Total Packages: ${totalPackages}\n‚Ä¢ Invoice: ${combinedInvoice}\n\n‚ö†Ô∏è This action cannot be undone!\n\nProceed with generating the combined document?`)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %} 